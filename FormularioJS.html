<script>
   var FormularioJS = {
         active: 0,
         aGuardar: {},
         edit: false,

         init: function () {
            console.log('Formulario INIT');
            MenuJS.closeWaitMessage();
            FormularioJS.ajustes();
         },
         columnas: {
            // Fecha Inicio, Fecha Final, Estatus, Asignado
            Aclaraciones: ['AX', null, null, 'AY'],
            AFG: ['AX', 'AZ', 'BA', 'AY'],
            Seguridad: ['BE', 'BG', 'BH', 'BF'],
            RCI: ['BI', 'BK', 'BJ', 'BT'],
            RRLL: [null, 'BZ', 'BO', null],
            Viabilidad: ['BP', 'BQ', 'BS', null],
            Auditoria: ['BU', 'BX', 'BW', 'BV'],
            Penal: [null, null, 'CE', null]
         }, documentosCoordenadas: {
            Aclaraciones: ['P','AC','AF'],
            AFG: ['Q','W','AF'],
            Seguridad: ['R','X','AE','AF','Z'],
            RCI: ['S','Z','AF'],
            RRLL: [],
            Viabilidad: [],
            Auditoria: ['AD','AF'],
            Penal: [],
            AFG2:['Y']
         },

         ajustes: function () {
            // Mas a menos los signos
            $('.panel .panel-heading button').click(function (event) {
               //console.log($(this).attr('id'));
               if ($(this).attr('id')) {
                  var id = $(this).attr('id').replace('btn_subir_', '');
                  FormularioJS.archivos.clientEmpleado(id)
               } else {
                  $(this).html() === '+' ? $(this).html('-') : $(this).html('+');
               }
            });
            // Añadiendo las opciones
            console.log('parametros para options 36 ');
            FormularioJS.opciones.agregar();
            // SelectPicker
            $('.selectpicker').selectpicker({
               style: 'form-control btn btn-2017 ',
               size: 4,
               actionsBox: true,
               deselectAllText: 'Ninguno',
               dropupAuto: true,
               noneSelectedText: 'Seleccione',
               selectAllText: 'Todos'
            });
            $(".site-tooltipTuto, .site-tooltipAlta").tooltip({
               //placement: "top",
               trigger: "hover",
               animation: true,
               html: true
            });
            // Creando nuevo
            //console.log('FormularioJS.edit',FormularioJS.edit);
            // por default edit false
            if (FormularioJS.edit) {
               FormularioJS.rellenar(FormularioJS.active);
            } else {
               //obtine la fila maxima del caso y se suma 1 en caso de tener registros y si no empieza por la columna 2
               FormularioJS.active = alasql('SELECT ROW MAX(indice) FROM transformaciones')[0] ? alasql('SELECT ROW MAX(indice) FROM transformaciones')[0] + 1 : 2;
               FormularioJS.aGuardar = FormularioJS.nuevoExcelRow();
               // genera  folio nuevos
               FormularioJS.aGuardar['CK'] = FormularioJS.folio.generar();
               // Agregando campos automáticos tomados de la base de datos : CR del usuario y area
               $('#cr_notifica').val(alasql('SELECT ROW cr FROM usuarios WHERE email="' + sessionStorage.NB_CORREO + '"')[0]);
               $('#cr_notifica').val().length > 2 ? $('#cr_notifica').prop("disabled", true) : $('#cr_notifica').prop("disabled", false);
               $('#area').val(alasql('SELECT ROW nb_puesto FROM puesto WHERE id_puesto = ' + sessionStorage.id_puesto)[0]).selectpicker('refresh');
               // Eventos para el validador de caracteres en los campos
               // cambios para validacion 8.10.19
               FormularioJS.validar.caracteres();
               FormularioJS.validar.archivos();
               // Botón de guardar en alta de caso, por cualquier area que suba casos
               $('#btn_datos_generales').click(function () {
                  //valida todos los campos del formulario
                  FormularioJS.validar.btnGuardar().then(function (status) {
                     // Guardando en el excel
                     FormularioJS.alasql.agregar(FormularioJS.aGuardar);
                     // Pasando a la siguiente fase
                     // seteando el valor de fecha de alta AFG
                     FormularioJS.alasql.modificar('AX', $('#fechaAlta').val());
                     // entra al cicuito de  alta
                     var circuitos = FormularioJS.validar.circuito('Alta');
                     circuitos.forEach((circuito) => {
                        FormularioJS.columnas[circuito][0] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][0], $('#fechaAlta').val()) : '';
                        FormularioJS.columnas[circuito][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][2], 'Pendiente') : '';
                     });
                     // Guardando
                     var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                     var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                     var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                     // Separando los clientes
                     status[1] = status[1].filter((objeto) => objeto['F'] !== undefined && objeto['G'] !== undefined && objeto['H'] !== undefined && objeto['I'] !== undefined && objeto['K'] !== undefined && objeto['L'] !== undefined && objeto['M'] !== undefined);
                     console.log('Aquí debemos guardar lo que viene siendo los clientes: ', status[1]);
                     // FormularioJS.sprdsheet.guardar('buscar', JSON.stringify(status[1]), 'Clientes');
                     // Guardar la persona que lo subió
                     FormularioJS.alasql.modificar('AQ', sessionStorage.NB_CORREO);
                     // Guardando
                     var area = alasql('SELECT ROW nb_puesto FROM puesto WHERE id_puesto =' + sessionStorage.id_puesto + '')[0];
                     FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data), 'Transformaciones');
                     var stringJson = status[1].map((sta) => {
                        return {
                           "0": sta["F"],
                           "1": sta["G"],
                           "2": sta["H"],
                           "3": sta["I"],
                           "4": sta["K"],
                           "5": sta["L"],
                           "6": sta["M"]
                        }
                     });
                     //console.table(JSON.stringify(stringJson));
                     FormularioJS.sprdsheet.guardar('buscar', JSON.stringify(stringJson), 'Clientes');
                     FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                        A: data['CK'],
                        B: area,
                        C: data['BA'],
                        D: data['AX'],
                        E: sessionStorage.NB_CORREO
                     }), 'Estatus');
                     alasql('INSERT INTO estatus SELECT * FROM ?', [
                        [{
                           "# Folio": data['CK'],
                           "Area": area,
                           "Estatus": data['BA'],
                           "Fecha": data['AX'],
                           "Usuario": sessionStorage.NB_CORREO,
                           "Observaciones": ''
                        }]
                     ]);
                     // Corrigiendo la descripción luego de guardarla
                     // FormularioJS.alasql.modificar('N', unescape(data['N']));
                     // Descargando la base nuevamente
                     HomeJS.obtenerDatosDeSpread();
                     console.dir('Guardado');
                     FormularioJS.correos('Alta', data, 'Alta');
                     BaseGenericJS.getContent("Home");
                  }).catch(function (status) {
                     console.dir(status);
                     var archivos = status[1].length !== 0 ? '<div class="alert alert-danger">Documentos obligatorios: ' + status[1].join('<br />') + '</div>' : '';
                     bootbox.alert({
                        message: '<div class="alert alert-danger">Todos los campos son obligatorios</div><div class="alert alert-danger">La descripción debe ser mínimo de 200 y máximo de 1500 caracteres</div>' + archivos,
                        buttons: {
                           ok: {
                              label: 'Cerrar',
                              className: 'btn-danger'
                           }
                        }
                     });
                  });
               });
               // Fecha de ahora mismo
               var fecha = new Date();
               $('#fechaAlta').val(fecha.getFullYear() + '-' + ("0" + (fecha.getMonth() + 1)).slice(-2) + '-' + ("0" + fecha.getDate()).slice(-2));
               // Ocultando las pestañas de áreas
               FormularioJS.validar.areas();
               // Contador de caracteres
               /*$('#descripcion1').on("keyup", function (e) {
                 valor = $(this).val();
                 $('#conteo_caracteres').find('span').html(valor.length);
               });*/
            }
            // Evitar que se copie y pegue
            //$('body').bind('copy',function(e) { e.preventDefault(); return false; });
            /*  $('textarea.desc').bind("paste",function(e) {
              console.log('evitar el pegado en textarea')
                //e.stopPropagation()
                e.preventDefault();
               // console.log(e.originalEvent.clipboardData.getData('text'), e.originalEvent.clipboardData.getData('text').toString().length > 1500);
                if (e.originalEvent.clipboardData.getData('text').length > 1500) {
                  bootbox.alert({
                    message: '<div class="alert alert-danger">SE HA CORTADO LA DESCRIPCIÓN. <br />La descripción debe ser mínimo de 200 y máximo de 1500 caracteres</div>',
                    buttons: { ok: { label: 'Cerrar', className: 'btn-danger'} }
                  });
                  $(this).val(e.originalEvent.clipboardData.getData('text').toString().substring(0, 1500));
                } else {
                  $(this).val(e.originalEvent.clipboardData.getData('text').toString());
                }
              });*/
            //funcion para que evite pegar, @gio
            $('#descripcion1').bind("paste", function (e) {
               e.preventDefault();
            })
         },

         alasql: {
            borrar: function (indice) {
               if (!indice) {
                  indice = FormularioJS.active;
               }
               alasql('DELETE FROM transformaciones WHERE indice =' + indice);
            },
            agregar: function (data) {
               if (!data) {
                  return
               }
               alasql('INSERT INTO transformaciones SELECT * FROM ?', [
                  [data]
               ]);
            },
            modificar: function (celda, data, indice) {
               // celda = 'A',
               // data = 'algo'
               if (!celda) {
                  return
               }
               var columna = celda;

               if (!indice) {
                  indice = FormularioJS.active;
               }
               alasql('UPDATE transformaciones SET ' + columna + ' = "' + data + '" WHERE indice = ' + indice);
            },
            obtener: function (indice) {
               if (!indice) {
                  return alasql('SELECT * FROM transformaciones');
               }
               return alasql('SELECT ROW * FROM transformaciones WHERE indice=' + indice);
            }
         },

         sprdsheet: {
            guardar: function (rango, data, cual) {
                   google.script.run.withSuccessHandler(function (response) {
                   console.log('SpreadSheet Guardado');
                   }).withFailureHandler(GenericJS.setFailure).transformacionesSaveSpreadSheet(rango, data, cual);
            },
            conFiltro: function (base, columna, filtro) {
               return new Promise(function (resolve, reject) {
                  google.script.run.withSuccessHandler(function (response2) {
                     var nombreTabla = base.toLowerCase();
                     console.dir('Base ' + nombreTabla + ': Actualizando');

                     var datos = JSON.parse(response2);
                     var objet = [];

                     var indc = 0;
                     datos.forEach((dato, index) => {
                        if (index == 0) {} else {
                           objet[indc] = {}
                           dato.forEach((dat, inde) => {
                              // var columna = HomeJS.numAColumn(inde + 1);
                              var columna = datos[0][inde];
                              if (dat !== '') {
                                 objet[indc][columna] = dat.toString();
                              }
                              objet[indc]["indice"] = index + 1;
                           });
                           indc += 1;
                        }
                     });
                     alasql('DROP TABLE IF EXISTS ' + nombreTabla);
                     alasql('CREATE TABLE ' + nombreTabla);
                     // alasql.tables.NombreTabla.data = data;
                     alasql('INSERT INTO ' + nombreTabla + ' SELECT * FROM ?', [objet]);
                     resolve('Base ' + nombreTabla + ': Actualizada');
                  }).withFailureHandler(JS_Base_Generic.setFailure).tranformacionesGetFilteredSpreadSheet(base, columna, filtro);
               });
            }
         },

         opciones: {
            agregar: function (selector, contenido) {
               console.log('console opciones agregar', selector, contenido);
               if (selector) {
                  var conOpciones = '',
                     opciones = alasql('SELECT ROW ' + contenido + ' FROM opciones')[0];
                  $(selector).html('');
                  if (opciones) {
                     opciones
                        .map((opcion) => '<option>' + opcion + '</option>')
                        .forEach((opcion) => {
                           $(selector).append(opcion)
                        });
                  }
                  $(selector).selectpicker('refresh');
               } else {
                  $('select').each((index, elegido) => {
                     console.log('formulario JS 243 : selects y options ', elegido);
                     if ($(elegido).attr('contenido')) {
                        var opciones = alasql('SELECT ROW ' + $(elegido).attr('contenido') + ' FROM opciones')[0];
                        if ($(elegido).attr('contenido') === 'asignado' && $(elegido).attr('area')) {
                           console.log('validacion de selects ', $(elegido).attr('area'));
                           var area = alasql('SELECT ROW id_puesto FROM puesto WHERE nb_puesto="' + $(elegido).attr('area') + '"').join('');
                           console.log('formularios js 249 area para la opciones', area);
                           //validacion para area de aclaraciones- auditoria refresh de select y options
                           if (area == '6') {
                              console.log('validacion para auditoria aclaraciones');
                              area = FormularioJS.obtener.validacionPorMonto(100000, 'area', 'refrescar slects cuando es perfil es aclaraciones -auditoria ', '6');
                           }
                           var datos = alasql('SELECT email, nombre FROM usuarios WHERE titular=0 && id_puesto=' + area).map((item) => '<option value="' + item.email + '">' + item.nombre + '</option>');
                           $(elegido).html(datos);
                           console.log('258', $(elegido).html(datos));
                        } else if (opciones) {
                           var conOpciones = '';
                           if (opciones[0].indexOf(',') !== -1) {
                              conOpciones = opciones.map((opcion) => '<option value="' + opcion.split(',')[1] + '">' + opcion.split(',')[0] + '</option>');
                           } else {
                              conOpciones = opciones.map((opcion) => '<option>' + opcion + '</option>');
                           }
                           conOpciones.forEach((opcion) => {
                              $(elegido).append(opcion)
                           });
                        }
                     }
                  });
               }
               // Agregando botones el añadir opciones
               $('button[name="clienteOpcionesAgregar"], button[name="empleadoOpcionesAgregar"]').click(function (e) {
                  var contenido = $(this).parent().parent().attr('id') === 'form_cliente' ?
                     '<div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="numCliente">Número de cliente</label>' +
                     '<input type="text" class="form-control" id="numCliente_" columna="F-" pattern="([0-9]*)(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="nombreCliente_AP_">Apellido Paterno del cliente</label>' +
                     '<input type="text" class="form-control text-uppercase" id="nombreCliente_AP_" columna="G-" pattern="([A-Za-zñÑ\\s]+)(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="nombreCliente_AM_">Apellido Materno del cliente</label>' +
                     '<input type="text" class="form-control text-uppercase" id="nombreCliente_AM_" columna="G-" pattern="([A-Za-zñÑ\\s]+)(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="nombreCliente_NM_">Nombre(s) del cliente</label>' +
                     '<input type="text" class="form-control text-uppercase" id="nombreCliente_NM_" columna="G-" pattern="([A-Za-zñÑ\\s]+)(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="cuentaCliente">Número de Cuenta del Cliente</label>' +
                     '<input type="text" class="form-control" id="cuentaCliente_" columna="I-" pattern="([0-9]*)(.*), $1" maxlength="10">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="tarjetaCliente">Número de Tarjeta de Débito</label>' +
                     '<input type="text" class="form-control" id="tarjetaCliente_" columna="H-" pattern="([0-9]*)(.*), $1" maxlength="16">' +
                     '</div><div class="clearfix"></div>' :
                     $(this).parent().parent().attr('id') === 'form_empleado' ?
                     '<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2 form-group">' +
                     '<label for="empleado_">M del empleado</label>' +
                     '<input type="text" class="form-control text-uppercase" id="empleado_" placeholder="MXXXXXX" columna="K-" pattern="(^[a-zA-Z](?:[a-zA-Z0-9]{0,5})?[0-9]?$)*(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="nombre_empleado_AP_">Apellido Paterno del empleado</label>' +
                     '<input type="text" class="form-control text-uppercase" id="nombre_empleado_AP_" placeholder="Nombre del empleado involucrado" columna="L-" pattern="([A-Za-zñÑ\\s]+)(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="nombre_empleado_AM_">Apellido Materno del empleado</label>' +
                     '<input type="text" class="form-control text-uppercase" id="nombre_empleado_AM_" placeholder="Nombre del empleado involucrado" columna="L-" pattern="([A-Za-zñÑ\\s]+)(.*), $1">' +
                     '</div><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3 form-group">' +
                     '<label for="nombre_empleado_NM">Nombre(s) del empleado</label>' +
                     '<input type="text" class="form-control text-uppercase" id="nombre_empleado_NM_" placeholder="Nombre del empleado involucrado" columna="L-" pattern="([A-Za-zñÑ\\s]+)(.*), $1">' +
                     '</div>' :
                     '';
                  $(this).parent().parent().append(contenido);
                  FormularioJS.validar.caracteres();
               });
               $('button[name="clienteOpcionesQuitar"], button[name="empleadoOpcionesQuitar"]').click(function (e) {
                  var indx = 0,
                     maxInx = $(this).parent().parent().attr('id') === 'form_cliente' ? 6 : $(this).parent().parent().attr('id') === 'form_empleado' ? 4 : 0;
                  $(this).parent().parent().find('.clearfix:last').remove();
                  while (indx < maxInx) {
                     var aQuitar = $(this).parent().parent().find('.form-group:last');
                     aQuitar.hasClass('btns') ? '' : aQuitar.remove();
                     indx += 1;
                  }
                  $('input[id*="_AP"], input[id="empleado"]').change();
               });
            },
            obtener: function () {
               google.script.run.withSuccessHandler(function (response) {
                  console.log('Opciones Guardadas', response);
                  alasql('DROP TABLE IF EXISTS opciones');
                  alasql('CREATE TABLE opciones');
                  // alasql.tables.NombreTabla.data = data;
                  alasql('INSERT INTO opciones SELECT * FROM ?', [
                     [response]
                  ]);
               }).withFailureHandler(GenericJS.setFailure).spreadSheetsGetOptions();
            }
         },

         nuevoExcelRow: function () {
            var objeto = {
                  indice: 2
               },
               maximo = 90;
            if (alasql('SELECT ROW * FROM transformaciones')) {
               objeto = {
                  indice: FormularioJS.active
               };
               maximo = alasql('SELECT ROW * FROM transformaciones').length - 1;
            }
            for (indx = 0; indx < maximo; indx += 1) {
               objeto[HomeJS.numAColumn(indx + 1)] = '';
            }
            return objeto;
         },

         actualizarDescripcion: function () {
            var descrip = $("#descripcion"),
               des1 = $('#descripcion1').val(),
               des2 = $('#descripcion2').val();
            if (des1 === '' && des2 === '') {
               return;
            }
            descrip.val(des1 + ' || ' + des2);
         },

         validar: {
            clientEmpleados: function (clientEmpleados, excel) {
               //console.log(excel, clientEmpleados)
               excel.forEach((clienteEmpleado, indice) => {
                  //console.log(indice);
                  !$('#form_' + clientEmpleados).find('.btns').hasClass('hide') ? $('#form_' + clientEmpleados).find('.btns').find('[name="' + clientEmpleados + 'OpcionesAgregar"]').click() : '';
                  $('#form_' + clientEmpleados).find('input').each((indx, element) => {
                     if ($(element).val() === '' && !$(element).parent().hasClass('hide')) {
                        $(element).val(clienteEmpleado[indc]).change();
                     }
                  });

                  //$('#form_' + clientEmpleados).find('.btns').removeClass('hide');
               });
               // Revisando los campos
               $('.avisos_not_found input, .avisos_not_found select, .avisos_not_found textarea').each(function () {
                  if ($(this).attr("columna")) {
                     var columnaConGuion = $(this).attr('columna'),
                        columna = $(this).attr('columna').replace('_', '').replace('-', ''),
                        nombres = [],
                        porcentaje = ['_F', '_I', '_H', '_K'].includes($(this).attr('columna')) ? 0 : 3;
                     //console.log($(this).attr('columna'));
                     if ($(this).attr('columna').indexOf('_') !== -1) {
                        console.log('porcentajes', porcentaje);
                        $('[columna="' + columnaConGuion + '"]').each((indx, este) => nombres.push($(este).val() + ' '));
                        console.log('nombres', nombres)
                        $('[columna="' + columna + '-"]').each((indx, este) => nombres.push(!(indx % porcentaje) ? ' || ' + $(este).val() : ' ' + $(este).val()));
                        console.log('nombres2', nombres)
                        $('[columna="' + columna + '"]').val(nombres.join('').toUpperCase().toUpperCase());
                     }
                  }
               });
            },
            /* area - string, avanza - boolean */
            circuito: function (area, avanza) {
               console.log('****************************************************************************************************************');
               area = area ? area : 'Alta';
               avanza = avanza ? avanza : true;
               console.log('donde estoy : ', area);
               console.log('donde voy : ', avanza);
               var areas = [],
                  aLaPar = [],
                  siguiente = [],
                  regresa = [];
               //obtine los estatus de las diferentes area para determinar el circuito
               var data = alasql('SELECT BA AS [AFG], BH AS [Seguridad], BJ AS [RCI], BO AS [RRLL], BS AS [Viabilidad], BW AS [Auditoria], P AS [cartaReclamacion], AC AS [cartaFiniquito], AA AS [cedulaQuebranto], CE AS [Penal], AR AS [tipologia] FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
               //var monto = alasql('SELECT D AS [monto] FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
               // Para conocer que área sigue de al actual
               switch (area) {
                  case 'Alta':
                     aLaPar = [];
                     siguiente = ['AFG'];
                     regresa = [];
                     break;
                  case 'Aclaraciones':
                     aLaPar = ['Viabilidad'];
                     // siguiente = ['Auditoria'];
                     siguiente = FormularioJS.obtener.validacionPorMonto(100000, 'siguiente', 'decidir el flujo hacia auditoria o aclaraciones -auditoria ', []);
                     regresa = [];
                     break;
                  case 'AFG':
                     aLaPar = ['Seguridad'];
                     // console.log('case AFG , aLaPar :',aLaPar);
                     //aLaPar=FormularioJS.obtener.validacionPorMonto(3000000,'aLaPar','manda el caso a aclaraciones auditoria si comuple la condicion ',[],aLaPar);
                     //console.log('case AFG , aLaPar :',JSON.stringify(aLaPar));
                     siguiente = [];
                     regresa = [];
                     break;
                  case 'AFG2':
                     aLaPar = ['AFG', 'Seguridad', 'Viabilidad'];
                     // siguiente = ['Auditoria'];
                     siguiente = FormularioJS.obtener.validacionPorMonto(100000, 'siguiente', 'decidir el flujo hacia auditoria o aclaraciones -auditoria ', []);
                     regresa = [];
                     break;
                  case 'RCI':
                     aLaPar = [];
                     siguiente = ['RRLL'];
                     regresa = ['AFG'];
                     break;
                  case 'Seguridad':
                     aLaPar = ['AFG'];
                     siguiente = [];
                     regresa = [];
                     break;
                  case 'RRLL':
                     aLaPar = [];
                     siguiente = [];
                     regresa = [];
                     break;
                  case 'Viabilidad':
                     //validacion de > 100k
                     // siguiente = monto.monto>100000? ['Auditoria']:['Aclaraciones-Auditoria'] ;
                     // siguiente =['Auditoria'];
                     siguiente = FormularioJS.obtener.validacionPorMonto(100000, 'siguiente', 'decidir el flujo hacia auditoria o aclaraciones -auditoria ', []);
                     aLaPar = [];
                     regresa = [];
                     break;
                  case 'Auditoria':
                     aLaPar = [];
                     siguiente = ['Penal'];
                     regresa = [];
                     break;
                  case 'Aclaraciones-Auditoria':
                     aLaPar = [];
                     siguiente = ['Penal'];
                     regresa = [];
                     break;
                  case 'Penal':
                     aLaPar = [];
                     siguiente = [];
                     //regresa = ['Auditoria'];
                     regresa = FormularioJS.obtener.validacionPorMonto(100000, 'siguiente', 'decidir el flujo hacia auditoria o aclaraciones -auditoria ', []);
                     break;
                  default:
               }
               // Casos dependiendo de las tipologías solo entra cuando ya esta dado de alta el caso y se encuntra en aFG o seguridad
               // se quitaran la tipologias por montos
               console.log('area : ', area);
               console.log('areas : ', areas);
               console.log('tipologia : ', data['tipologia']);
               if (areas.length == 0 && (area === 'AFG' || area === 'Seguridad')) {
                  if (data['tipologia'] === 'Consultas Injustificadas') {
                     //siguiente = ['RCI'];
                     aLaPar = ['RCI'];
                  } else if (data['tipologia'] === 'Tentativa de Fraude') {
                     siguiente = ['RRLL'];
                  } else {
                     siguiente = ['RRLL', 'Viabilidad'];
                  }
               }
               console.log('siguiente', siguiente);
               console.log('aLaPar', aLaPar);
               aLaPar.forEach((inmediato) => {
                  console.log('for each alapar : ', data[inmediato]);
                  $.trim(data[inmediato]) === 'Terminado' ? '' : areas.push(inmediato);
               });
               if (areas.length === 0 && area !== 'Alta') {
                  siguiente.forEach((inmediato) => {
                     console.log('data inmediato', data[inmediato], ':::::::::: inmediato', inmediato, ':::::::::::::: data :::', data);
                     data[inmediato] === 'Terminado' ?
                        '' :
                        (inmediato === 'Auditoria' || inmediato === 'Aclaraciones-Auditoria') && ($.trim(data['cartaFiniquito']) === '' || $.trim(data['cartaReclamacion']) === '' || $.trim(data['cedulaQuebranto']) === '') ?
                        '' :
                        areas.push(inmediato);
                     area === 'Alta' ? areas.push(inmediato) : '';
                  });
               } else if (areas.length === 0 && area === 'Alta') {
                  areas = siguiente;
               }
               console.log('area direfente de alta : ', area);
               // Revisando que las áreas que quedan, no ya estén notificadas
               console.log('areas aa enviar notificacion :::  ', areas);
               console.log('siguiente antes de validacion', siguiente);
               console.log('data', data);
               areas = area === 'Alta' ? areas : areas.filter((area) => $.trim(data[area]) === '');
               console.log('492 return circuito  :   ', areas);
               return avanza ? areas : regresa;
            },
            btnGuardar: function () {
               return new Promise(function (resolve, reject) {
                  var validacion = true;
                  // Validar Campos Generales
                  var campos = $('#form_general input, #form_general select, #form_cliente input, #form_cliente select, #form_empleado input, #form_empleado select, #form_descripcion input');
                  var clientes = {},
                     excluidos = ['caso'];
                  console.log('validacion de excluidos', sessionStorage.id_puesto !== '8');
                  if (sessionStorage.id_puesto !== '8') {
                     excluidos.push('numAclaracion');
                  }
                  campos.each((indx, campo) => {
                     var columna = $(campo).attr('columna'),
                        valor = $(campo).val().trim();
                     console.log('excluidos', excluidos);
                     if (columna && !excluidos.includes($(campo).attr('id'))) {
                        /*if ($(campo).attr('id') === '#tarjetaCliente_' || $(campo).attr('id') === '#tarjetaCliente_') {
                          $('#tarjetaCliente_').val().length === 10 || $('#tarjetaCliente_').val().length === 16);
                        }*/
                        console.log('valor de los campos ::::: ', valor, '::::campos :::::', columna);
                        if (valor === '') {
                           validacion = false;
                           $(campo).parent().addClass('has-error');
                        } else {
                           $(campo).parent().removeClass('has-error');
                           // No guardar los campos de empleado y cliente
                           if (!['F', 'G', 'H', 'I', 'K', 'L'].includes(columna)) {
                              FormularioJS.aGuardar[columna] === '' ? FormularioJS.aGuardar[columna] = valor : '';
                           } else {
                              clientes[columna] = valor;
                           }
                        }
                     }
                  });
                  var empleados = [];
                  Object.keys(clientes).forEach((cliente) => {
                     clientes[cliente].split(' || ').forEach((empleado, index) => {
                        empleados[index] ? '' : empleados[index] = {};
                        empleados[index][cliente] = empleado;
                     });
                  });
                  var clientEmpleado = [];
                  empleados.forEach((empleado) => {
                     empleado['M'] = FormularioJS.folio.obtener();
                     var clnt = Object.assign({}, empleado),
                        empld = Object.assign({}, empleado);
                     clnt['K'] = '';
                     clnt['L'] = '';
                     empld['F'] = '';
                     empld['G'] = '';
                     empld['H'] = '';
                     empld['I'] = '';
                     clientEmpleado.push(clnt);
                     clientEmpleado.push(empld);
                  });

                  // Añadiendo empleados y clientes
                  FormularioJS.aGuardar['G'] = clientEmpleado.filter((empelado) => empleado['G'] !== '')[0]['G'];
                  FormularioJS.aGuardar['F'] = clientEmpleado.filter((empelado) => empleado['F'] !== '')[0]['F'];

                  // Validación de Descripción
                  var descripcion = true;
                  campos = $('#form_descripcion input, #form_descripcion textarea');
                  campos.each((indx, campo) => {
                     var valor = $(campo).val();
                     if (valor === '' || $('#form_descripcion textarea').val().length < 200) {
                        descripcion = false;
                        validacion = false;
                        $(campo).parent().addClass('has-error');
                     } else {
                        $(campo).parent().removeClass('has-error');
                     }
                  });
                  // Validación de Archivos
                  var archivos = true;
                  var obligados = []
                  if ($('#form_documentos').children('div:not(.hide)').children('div[obligatorio="true"]').length !== 0) {
                     validacion = false;
                     $('#form_documentos').children('div:not(.hide)').children('div[obligatorio="true"]').each((indx, obligado) => {
                        obligados.push($(obligado).parent().find('label').html());
                     });
                  }
                  // Validación
                  descripcion === true ? FormularioJS.aGuardar['N'] = escape($('#form_descripcion #descripcion').val().trim()) : '';
                  validacion === true ? resolve(["Formulario Validado", clientEmpleado]) : reject(["Formulario Incorrecto", obligados]);
               })
            },
            areas: function (area) {
               area = area ? area : 'todas';
               console.log('entramos a funcionalidad de areas: 570:   ', area);
               var fecha = GenericJS.obtenerFechaSinHoras();
               switch (area) {
                  case 'todas':
                     FormularioJS.validar.caracteres();
                     if (FormularioJS.edit === true) {
                        if (sessionStorage.id_puesto === "1") {
                           $('.vista_reporte').addClass('hide');
                           $('.vista_editable .panel').removeClass('hide');
                           /*var columnas = [];
                           $('[columna*="_"]').each((indx, este) => columnas.push($(este).attr('columna').slice(1)));
                           columnas.filter(function(item, pos, self) {return self.indexOf(item) == pos;}).forEach(col => {$('[columna="' + col + '"]').parent().removeClass('hide');$('[columna="_' + col + '"]').parent().addClass('hide')});
                           */
                           //FormularioJS.validar.archivos();
                           // return;
                        }
                        FormularioJS.validar.archivos();
                        $('#form_areas').show();
                        $('#btn_datos_generales').hide();
                        $('#form_areas div[class*="botonera"').addClass('hide');
                        var datos = alasql('SELECT * FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                        var rol = datos[FormularioJS.columnas['Penal'][2]] !== '' && sessionStorage.id_puesto === '10' ? 1 : 0;
                        //var puesto = alasql('SELECT ROW nb_area FROM (SELECT * FROM usuarios JOIN puesto_area USING id_puesto JOIN area USING id_area WHERE email="' + sessionStorage.NB_CORREO + '")')[rol];
                        var puesto = alasql('SELECT nb_area FROM (SELECT * FROM usuarios JOIN puesto_area USING id_puesto JOIN area USING id_area WHERE email="' + sessionStorage.NB_CORREO + '")')[rol].nb_area;
                        var permisosUsuario = [puesto];
                        var permisosEstatus = {
                           Aclaraciones: 'BS',
                           AFG: 'BA',
                           Seguridad: 'BH',
                           RRLL: 'BO',
                           Viabilidad: 'BS',
                           Auditoria: 'BW',
                           Penal: 'CE'
                        };
                        $('li[id*="tabs"]').addClass('hide');
                        // var active = $('li[id*="tabs"]:not([class*="hide"]):last').attr('id') ? $('li[id*="tabs"]:not([class*="hide"]):last').attr('id').replace('tabs', '') : '';
                        var active = puesto;
                        console.log('active principal para determianr el camino del flujo y calculos', active);
                        var titular = alasql('SELECT ROW titular FROM usuarios WHERE email = "' + sessionStorage.NB_CORREO + '"')[0];
                        $('li#tabs' + active).removeClass('hide');
                        $('#tabs' + active + ', #cuestionario' + active).addClass('active');
                        (datos[permisosEstatus[active]] !== 'Terminado') ? $('div[class*="botonera' + active + '"]').removeClass('hide'): '';
                        // Realizando los cambios cuando entra un admin o se encuentra no asignado.
                        //Funcion poene el cuestionario de acerdo al perfil
                        console.log('condicion para primer flujo 605', $('#cuestionario' + active).find('select[contenido="asignado"]'));
                        if ($('#cuestionario' + active).find('select[contenido="asignado"]').length !== 0) {
                           var colAsignado = $('#cuestionario' + active).find('select[contenido="asignado"]').attr('columna');
                           console.log('608 ', colAsignado);
                           // if (datos[colAsignado] === '' || datos[permisosEstatus[active]] !== 'Asignado' && datos[permisosEstatus[active]] !== 'Terminado' && datos[permisosEstatus[active]] !== 'Rechazado') {

                           // e no hay nadie Asigando
                           if (datos[permisosEstatus[active]] === 'Pendiente' && titular === 1 && datos[colAsignado] === '') {
                              console.log('liena 612 , estatus pendiente , coordiandor , sin asginacion');
                              $('.selectpicker').selectpicker('refresh');
                              $('#cuestionario' + active + ' div.row').children('div.form-group').addClass('hide');
                              $('.botonera' + active).find('button[name="Aprobar"]').toggleClass('hide');
                              $('#cuestionario' + active).find('select[contenido="asignado"], select[contenido="tipologia"], select[contenido="modus_operandi"], select[contenido="prioridad"]')
                                 .parent()
                                 .parent()
                                 .removeClass('hide');
                              // basado en el monto del alta , el combo tiene la descripcion de la tipologia
                              /*  var fraude = datos['D'] = 0
                                  ? 'Consultas Injustificadas'
                                  : datos['D'] > 3000000
                                    ? 'Fraude Consumado > 3 000,000'
                                    : datos['D'] > 100000
                                      ? 'Fraude Consumado > 100,000'
                                      : datos['D'] < 100000
                                        ? 'Fraude Consumado < 100,000'
                                        : 'Consultas Injustificadas'; */
                              //  $('#cuestionario' + active).find('select[contenido="tipologia"]').val(fraude).selectpicker('refresh');
                              $('#cuestionario' + active).find('input#caso').parent().parent().removeClass('hide');
                              $('#buscar').removeAttr('disabled');
                              //terminado  o rechazado
                           } else if (datos[permisosEstatus[active]] === 'Terminado' || datos[permisosEstatus[active]] === 'Rechazado') {
                              console.log('estatus terminado o estatus rechazados  636')
                              //analista que no coincide con el asignado
                              if (titular === 0 && datos[FormularioJS.columnas[active][3]] !== sessionStorage.NB_CORREO && sessionStorage.id_puesto !== '11') {
                                 console.log('639');
                                 $('#cuestionario' + active).find('select').attr('disabled', 'disabled').selectpicker('refresh');
                                 $('#cuestionario' + active).find('input').attr('disabled', 'disabled');
                                 $('#buscar').attr('disabled', 'disabled');
                                 $('.botonera' + active).find('button').addClass('hide');
                              } else if (active === 'AFG' && titular === 0 && datos['BW'] === '' && datos[FormularioJS.columnas[active][2]] !== 'Pendiente' && datos[FormularioJS.columnas[active][2]] !== 'Terminado') {
                                 console.log('644');
                                 // AFG Puede modificar sólo dos cosas antes de que llegue a Auditoría
                                 $('#cuestionario' + active).find('select').attr('disabled', 'disabled').selectpicker('refresh');
                                 $('#cuestionario' + active).find('input').attr('disabled', 'disabled');
                                 $('#buscar').attr('disabled', 'disabled');
                                 $('#cuestionario' + active).find('#importe_quebranto, #importe_recuperacion').removeAttr('disabled').selectpicker('refresh')
                                 $('.botonera' + active).removeClass('hide');
                                 $('.botonera' + active).find('button').addClass('hide');
                                 $('.botonera' + active).find('button[name="Guardar"]').removeClass('hide');
                                 //cordinador con puesto direferente de AFG Quebranto
                              } else if (titular === 1 && sessionStorage.id_puesto !== '11') {
                                 console.log('656')
                                 // Para reabrir el caso
                                 $('.botonera' + active).removeClass('hide');
                                 $('.botonera' + active).find('button').addClass('hide');
                                 $('.botonera' + active).find('button[name="Reabrir"]').removeClass('hide');
                                 // puesto de AFG Quebranto
                              } else if (sessionStorage.id_puesto === '11') {
                                 console.log('663')
                                 console.log('Puesto de AFG para subir la cédula de quebranto');
                                 $('#tabs' + active).parent().addClass('hide');
                                 $('#cuestionario' + active + ' div.row').children('div').addClass('hide');
                                 $('.botonera' + active).removeClass('hide');
                                 $('.botonera' + active).find('button').addClass('hide');
                                 $('.botonera' + active).find('button[name="Guardar"]').removeClass('hide');
                              } else {
                                 console.log('671');
                                 $('#cuestionario' + active).find('select').attr('disabled', 'disabled').selectpicker('refresh');
                                 $('#cuestionario' + active).find('input').attr('disabled', 'disabled');
                                 $('#buscar').attr('disabled', 'disabled');
                              }
                           } else {
                              // analista asignado al caso
                              console.log('678');
                              if (titular === 0 && datos[FormularioJS.columnas[active][3]] === sessionStorage.NB_CORREO) {
                                 console.log('680')
                                 $('#cuestionario' + active)
                                    .find('select[contenido="asignado"], select[contenido="tipologia"], select[contenido="modus_operandi"], select[contenido="prioridad"]')
                                    .attr('disabled', 'disabled')
                                    .selectpicker('refresh');
                                 $('#cuestionario' + active).find('input#caso').attr('disabled', 'disabled');
                                 $('#buscar').attr('disabled', 'disabled');
                                 $('.botonera' + active).find('button').addClass('hide');
                                 $('.botonera' + active).find('button[name="Guardar"]').removeClass('hide');
                                 $('.botonera' + active).find('button[name="Aprobar"]').removeClass('hide').html('Enviar');
                                 // coordinadores  ,con estatus pendiente y hay alguien asgindo
                              } else if (FormularioJS.columnas[active][3] && datos[permisosEstatus[active]] === 'Pendiente' && titular === 1) {
                                 console.log('692')
                                 $('#cuestionario' + active + ' div.row').children('div.form-group').addClass('hide');
                                 $('#cuestionario' + active).find('select[contenido="asignado"], select[contenido="tipologia"], select[contenido="modus_operandi"], select[contenido="prioridad"], input[id="caso"]')
                                    .parent()
                                    .parent()
                                    .removeClass('hide');
                                 $('.botonera' + active).find('button[name="Aprobar"]').toggleClass('hide');
                                 $('.selectpicker').selectpicker('refresh');
                                 /*      var fraude = datos['D'] = 0
                                         ? 'Consultas Injustificadas'
                                         : datos['D'] > 3000000
                                           ? 'Fraude Consumado > 3 000,000'
                                           : datos['D'] > 100000
                                             ? 'Fraude Consumado > 100,000'
                                             : datos['D'] < 100000
                                               ? 'Fraude Consumado < 100,000'
                                               : 'Consultas Injustificadas'; */
                                 //$('#cuestionario' + active).find('select[contenido="tipologia"]').val(fraude).selectpicker('refresh');
                              } else {
                                 console.log('711');
                                 if (titular === 0) {
                                    // No tiene permisos para modificar nada
                                    $('#cuestionario' + active).find('select').attr('disabled', 'disabled').selectpicker('refresh');
                                    $('#cuestionario' + active).find('input').attr('disabled', 'disabled');
                                    $('#buscar').attr('disabled', 'disabled');
                                    $('.botonera' + active).find('button').addClass('hide');
                                 } else {
                                    console.log('719');
                                    $('#cuestionario' + active + ' div.row').children('div.form-group').addClass('hide');
                                    $('#cuestionario' + active).find('select[contenido="asignado"], select[contenido="tipologia"], select[contenido="modus_operandi"], select[contenido="prioridad"], input[id="caso"]')
                                       .parent()
                                       .parent()
                                       .removeClass('hide');
                                    $('.botonera' + active).find('button[name="Aprobar"]').toggleClass('hide');
                                    $('.selectpicker').selectpicker('refresh');
                                    /* var fraude = datos['D'] = 0
                                       ? 'Consultas Injustificadas'
                                       : datos['D'] > 3000000
                                         ? 'Fraude Consumado > 3 000,000'
                                         : datos['D'] > 100000
                                           ? 'Fraude Consumado > 100,000'
                                           : datos['D'] < 100000
                                             ? 'Fraude Consumado < 100,000'
                                             : 'Consultas Injustificadas'; */
                                    //  $('#cuestionario' + active).find('select[contenido="tipologia"]').val(fraude).selectpicker('refresh');
                                 }
                              }
                           }
                        } else {
                           console.log('741');
                           $('.botonera' + active).find('button').addClass('hide');
                           if (active === 'Penal' || $.trim(datos['CD']) !== '') {
                              console.log('744');
                              $('.botonera' + active).find('button[name="Guardar"]').removeClass('hide');
                              datos['CC'] !== '' ? $('#cuestionario' + active).find('input#fechaRecPruebasJ').attr('disabled', 'disabled') : '';
                              datos['CD'] !== '' ? $('#cuestionario' + active).find('input#fechaPresDenunciaJ').attr('disabled', 'disabled') : '';
                              $('#cuestionario' + active).find('.label-status').parent().addClass('hide');
                           } else if (sessionStorage.id_puesto === "8") { // Cuando es Aclaraciones
                              console.log('750')
                              var estado = alasql('SELECT ROW area FROM slas WHERE folio="' + datos['CK'] + '"')[0];
                              if (datos['AR'] === 'Consultas Injustificadas' || $.trim(datos['AR']) === '' || datos[permisosEstatus[estado]] === 'Rechazado') { // Y Consulta injustificada o casos rechazados
                                 console.log('753')
                                 $('#cuestionario' + active + ', #tabs' + active).addClass('hide');
                                 $('#form_documentos').parent().hide();
                              } else if (datos['P'] !== '' && datos['AC'] !== '' && datos['BW'] !== '') { // Cuando es aclaraciones y ya estan los archivos y ya se encuentra en Auditoría
                                 console.log('757');
                                 $('#cuestionario' + active + ', #tabs' + active).addClass('hide');
                                 $('.botonera' + active + ', .btnQuitar').addClass('hide');
                              } else {
                                 console.log('761')
                                 $('.botonera' + active).removeClass('hide');
                                 $('.botonera' + active).find('button').removeClass('hide');
                              }
                           } else if ((datos[permisosEstatus[active]] === 'Terminado' || datos[permisosEstatus[active]] === 'Rechazado') && titular === 1 && active !== 'RRLL') {
                              // Para Reabrir el Caso
                              console.log('767');
                              $('.botonera' + active).find('button').addClass('hide');
                              $('.botonera' + active).find('button[name="Reabrir"]').removeClass('hide');
                           } else if ((datos[permisosEstatus[active]] === 'Terminado' || datos[permisosEstatus[active]] === 'Rechazado') && (titular === 0 || active === 'RRLL')) {
                              console.log('771');
                              $('#cuestionario' + active).find('select').attr('disabled', 'disabled').selectpicker('refresh');
                              $('#cuestionario' + active).find('input').attr('disabled', 'disabled');
                              $('#buscar').attr('disabled', 'disabled');
                           } else {
                              console.log('776')
                              $('.botonera' + active).find('button[name="Rechazar"]').removeClass('hide');
                              $('.botonera' + active).find('button[name="Aprobar"]').removeClass('hide');
                           }
                           if (active === 'RRLL' && datos[permisosEstatus[active]] === 'Pendiente') {
                              console.log('781');
                              $('.botonera' + active).find('button[name="Aprobar"]').removeClass('hide');
                           }
                        }
                        // Botón de Buscar caso
                        $('div#cuestionarioAFG #buscar').on('click', function () {
                           if ($(this).attr('disabled')) {
                              return;
                           }
                           FormularioJS.modal.AFG.buscarCasoSimilar(FormularioJS.active);
                        });
                        // Label de la Vigencia
                        // continua llenando los campos
                        console.log('label de la vigencia');
                        if (datos[permisosEstatus[active]] === 'Rechazado' || active === 'Aclaraciones' || sessionStorage.id_puesto === '11') {
                           $('#cuestionario' + active).find('div.label-status').parent().addClass('hide');
                        } else {
                           vigencia = FormularioJS.obtener.vigencia(active, FormularioJS.active);
                           $('#cuestionario' + active).find('div.label-status')
                              .addClass(vigencia[2])
                              .html(vigencia[0])
                              .attr('data-original-title', vigencia[1])
                              .parent().removeClass('hide');
                        }
                        // On input de los campos
                        $('#importe_quebranto, #importe_recuperacion').on('input', function (e) {
                           console.log('849');
                           var quebranto = $('#importe_quebranto').val(),
                              recuperacion = $('#importe_recuperacion').val();
                           $('#importe_total').val(quebranto - recuperacion).attr('disabled', 'disabled');
                        });
                        // On change de los campos
                        $('select#tipologia').on('change', function (e) {
                           console.log('856');
                           if ($(this).val() === 'Consultas Injustificadas') {
                              $('#importe_total, #importe_quebranto, #importe_recuperacion').parent().hide();
                           } else {
                              $('#importe_total, #importe_quebranto, #importe_recuperacion').parent().show();
                           }
                        });
                        datos[$('select#tipologia').attr('columna')] === 'Consultas Injustificadas' ? $('#importe_total').parent().hide() : $('#importe_total').parent().show();

                        if (datos[colAsignado] !== '') {
                           $('#dg_areas_a').on('change', function (e) {
                              var contenido = $(this).val();
                              if (contenido === ' ') {
                                 $('#dg_areas_b, #dg_areas_c').parent().parent().addClass('hide');
                              } else {
                                 console.log('parametros para options 839 ');
                                 FormularioJS.opciones.agregar('#dg_areas_b', contenido);
                                 $('#dg_areas_b, #dg_areas_c').parent().parent().removeClass('hide');
                              }
                           });
                        }
                        $('#junicioPenalJ').on('change', function (e) {
                           var contenido = $(this).val();
                           console.log('parametros para options 879 ');
                           FormularioJS.opciones.agregar('#estatusPenalJ', contenido);
                        });
                        console.log('parametros para options 880 ');
                        FormularioJS.opciones.agregar('#estatusPenalJ', $('#junicioPenalJ').val());
                        if (active === 'Penal') {
                           $('.botonera' + active).find('button[name="Guardar"]').removeClass('hide');
                        }
                        //---------------------------- On click de los botones -------------------------------------------------------
                        var valido = true;
                        $('button[name="Aprobar"]').click(function (e) {
                            MenuJS.openLilWaitMessage();
                           e.preventDefault();
                           e.stopPropagation();
                          $.when(FormularioJS.obtener.sobreEscrituraSheet()).then(function(response){
                            MenuJS.closeLilWaitMessage();
                            console.log('button[name="Aprobar"] accion enviada ......');
                            valido = FormularioJS.validar.areas(active, "Aprobar");
                            var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                            var aclaraciones = active === 'Aclaraciones' ? "Aprobado" : 'Terminado';
                            if (valido[0] === true && active !== 'Viabilidad') { // PAra todo que no es viabilidad
                               var circuitos = FormularioJS.validar.circuito(active);
                               (active === 'Viabilidad') ? FormularioJS.alasql.modificar('BR', 'Aceptado'): '';
                               FormularioJS.columnas[active][1] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][1], fecha) : '';
                               FormularioJS.columnas[active][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], 'Terminado') : '';
                               console.log('Circuitos', circuitos, 'active ..', active);
                               circuitos.length !== 0 || active === 'RRLL' ? FormularioJS.correos(aclaraciones, data, active) : '';
                               circuitos.forEach((circuito) => {
                                  //if (FormularioJS.columnas[circuito][2] === '') {
                                  //validacion para aclaraciones Auditoria
                                  if (circuito == 'Aclaraciones-Auditoria') {
                                     circuito = 'Auditoria'
                                  };
                                  console.log('for each en 898', circuito);
                                  FormularioJS.columnas[circuito][0] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][0], fecha) : '';
                                  FormularioJS.columnas[circuito][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][2], 'Pendiente') : '';
                                  //}
                                  if (circuito === 'Seguridad') {
                                     FormularioJS.correos('sincartaFiniquito', data, active);
                                  }
                               });
                               data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                               var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                               var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                               /*if (data['N'].indexOf(',') !== -1) {
                                 data['N'] = escape(data['N']);
                               }*/
                               console.log('912', FormularioJS.active, '****', data);
                               FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data));
                               console.log('914 guardado 1');
                               FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                  A: data['CK'],
                                  B: active,
                                  C: 'Terminado',
                                  D: fecha,
                                  E: sessionStorage.NB_CORREO
                               }), 'Estatus');
                               console.log('916 guardado 2');
                               MenuJS.closeLilWaitMessage();
                               setTimeout(function () {
                                  BaseGenericJS.getContent("Home");
                                  MenuJS.closeLilWaitMessage();
                                  FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                     A: data['CK'],
                                     B: circuitos[0],
                                     C: 'Pendiente',
                                     D: fecha,
                                     E: sessionStorage.NB_CORREO
                                  }), 'Estatus');
                                  console.log('922 guardado 3');
                               }, 1000);
                            } else if (valido[0] === true && active === 'Viabilidad') {
                               bootbox.dialog({
                                  title: 'Viabilidad del caso:',
                                  message: "<p>Explica el motivo por el cual es viable.</p><textarea id='algo' style='width: 100%'></textarea>",
                                  size: 'large',
                                  buttons: {
                                     rechazo: {
                                        label: "Viable",
                                        className: 'btn-danger',
                                        callback: function () {
                                           if ($.trim($('#algo').val()) !== '') {
                                              var circuitos = FormularioJS.validar.circuito(active);
                                              (active === 'Viabilidad') ? FormularioJS.alasql.modificar('BR', 'Aceptado'): '';
                                              FormularioJS.columnas[active][1] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][1], fecha) : '';
                                              FormularioJS.columnas[active][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], 'Terminado') : '';
                                              console.log('formulariojs 900 -Donde se dirige el flujo de viabilidad ::::: ', circuitos)
                                              circuitos.length !== 0 || active === 'RRLL' ? FormularioJS.correos(aclaraciones, data, active) : '';
                                              console.log('pase coreos');
                                              // pone es el estatus de pendiente al la siguiente area @param circuitos
                                              circuitos.forEach((circuito) => {
                                                 //if (FormularioJS.columnas[circuito][2] === '') {
                                                 console.log('formulariojs 906 -', circuito);
                                                 //validacion para Aclaraciones-Auditoria comparte las mismas columnas que audtoria cambioamos el nombre.
                                                 if (circuito == 'Aclaraciones-Auditoria') {
                                                    circuito = 'Auditoria'
                                                 };
                                                 console.log('formulariojs 909 -', circuito);
                                                 FormularioJS.columnas[circuito][0] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][0], fecha) : '';
                                                 FormularioJS.columnas[circuito][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][2], 'Pendiente') : '';
                                                 //}
                                              });
                                              data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                                              var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                                              var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                                              /*if (data['N'].indexOf(',') !== -1) {
                                                data['N'] = escape(data['N']);
                                              }*/
                                              // console.log('guardar dato FormularioJS.sprdsheet.guardar',rango, JSON.stringify(data))
                                              FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data));
                                              var motivoViable = $('#algo').val();
                                              FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                                 A: data['CK'],
                                                 B: active,
                                                 C: 'Viable',
                                                 D: fecha,
                                                 E: sessionStorage.NB_CORREO,
                                                 F: motivoViable
                                              }, ), 'Estatus');
                                              MenuJS.closeLilWaitMessage();
                                              setTimeout(function () {
                                                 BaseGenericJS.getContent("Home");
                                                 MenuJS.closeLilWaitMessage();
                                                 FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                                    A: data['CK'],
                                                    B: circuitos[0],
                                                    C: 'Pendiente',
                                                    D: fecha,
                                                    E: sessionStorage.NB_CORREO
                                                 }), 'Estatus');
                                              }, 1000);


                                           }
                                        }
                                     },
                                     cancelar: {
                                        label: "cerrar",
                                        className: 'btn-info',
                                        callback: function () {
                                           MenuJS.closeLilWaitMessage()
                                        }
                                     }
                                  }
                               });
                            } else {
                               MenuJS.closeLilWaitMessage();
                               bootbox.alert({
                                  message: '<div class="alert alert-danger">Todos los campos son obligatorios</div>' + valido[1],
                                  buttons: {
                                     ok: {
                                        label: 'Cerrar',
                                        className: 'btn-danger'
                                     }
                                  }
                               });
                            }
                            // Mandar correo cuando Ya se llenó la carta finiquito
                            if (data['AC'] !== '' && sessionStorage.id_puesto === '8' && data['BA'] !== 'Pendiente') {
                               FormularioJS.correos('cartaFiniquito', data, 'AFG2');
                            }
                          });
                        });
                        $('button[name="Reabrir"]').click(function (e) {
                            MenuJS.openLilWaitMessage();
                            $.when(FormularioJS.obtener.sobreEscrituraSheet()).then(function(response){
                              MenuJS.closeLilWaitMessage();
                              console.log('reabrir el caso');
                              e.preventDefault();
                              e.stopPropagation();
                              activeReal = $(this).parent().parent().attr("class").split(" ").filter((clase) => RegExp(/^botonera/).test($.trim(clase)))[0].replace('botonera', '');
                              console.log('activeReal : ', activeReal);
                              FormularioJS.alasql.modificar(FormularioJS.columnas[activeReal][0], moment().format('YYYY-MM-DD'));
                              FormularioJS.alasql.modificar(FormularioJS.columnas[activeReal][1], '');
                              FormularioJS.alasql.modificar(FormularioJS.columnas[activeReal][2], 'Pendiente');
                              FormularioJS.alasql.modificar(FormularioJS.columnas[activeReal][3], '');
                              var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                              console.log('reabrir el caso datos :', data);
                              var lastRow = HomeJS.numAColumn(Object.keys(data).length);
                              var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                              console.log('rango', rango);
                              FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data));
                              FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                 A: data['CK'],
                                 B: active,
                                 C: 'Terminado',
                                 D: fecha,
                                 E: sessionStorage.NB_CORREO
                              }), 'Estatus');
                              FormularioJS.correos('Reabrir', data);
                              setTimeout(function () {
                                 BaseGenericJS.getContent("Home");
                                 MenuJS.closeLilWaitMessage();
                                 FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                    A: data['CK'],
                                    B: circuitos[0],
                                    C: 'Pendiente',
                                    D: fecha,
                                    E: sessionStorage.NB_CORREO
                                 }), 'Estatus');
                              }, 1000);
                            });
                        });
                        $('button[name="Rechazar"]').click(function (e) {
                            MenuJS.openLilWaitMessage();
                            $.when(FormularioJS.obtener.sobreEscrituraSheet()).then(function(response){
                              MenuJS.closeLilWaitMessage();
                              var motivoSelect = active === 'AFG' ? '' : '<select class="form-control bbva02 selectpicker" name="motivo_rechazo" id="motivo_rechazo" contenido="motivo_rechazo"></select>';
                              bootbox.dialog({
                                 title: active === 'AFG' ? 'Descartar caso:' : 'Rechazar caso:',
                                 message: '<p>Explica el motivo del rechazo del caso.</p>' + motivoSelect + '<textarea id="algo" style="width: 100%; resize: none" rows="3"></textarea>',
                                 size: 'large',
                                 buttons: {
                                    rechazo: {
                                       label: active === 'AFG' ? 'Descartar' : "Rechazar caso",
                                       className: 'btn-danger',
                                       callback: function () {
                                          //valido = FormularioJS.validar.areas(active, 'Rechazar');
                                          if ($('#algo').val() !== '') {
                                             FormularioJS.columnas[active][1] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][1], fecha) : '';
                                             if (active === 'Viabilidad') {
                                                FormularioJS.alasql.modificar('BR', 'Rechazado');
                                                FormularioJS.columnas[active][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], 'Terminado') : '';
                                             } else {
                                                FormularioJS.columnas[active][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], 'Rechazado') : '';
                                             }
                                             var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                                             var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                                             var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                                             if (data['N'].indexOf(',') !== -1) {
                                                data['N'] = escape(data['N']);
                                             }
                                             var motivoRechazo = ($('#motivo_rechazo').length !== 0 ? $('#motivo_rechazo').val() + ' || ' : '') + $('#algo').val();
                                             FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data));
                                             FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                                                A: data['CK'],
                                                B: active,
                                                C: 'Rechazado',
                                                D: fecha,
                                                E: sessionStorage.NB_CORREO,
                                                F: motivoRechazo
                                             }), 'Estatus');
                                             alasql('INSERT INTO estatus SELECT * FROM ?', [
                                                [{
                                                   "# Folio": data['CK'],
                                                   "Area": active,
                                                   "Estatus": 'Rechazado',
                                                   "Fecha": fecha,
                                                   "Usuario": sessionStorage.NB_CORREO,
                                                   "Observaciones": motivoRechazo
                                                }]
                                             ]);
                                             FormularioJS.correos('Rechazado', data);
                                             setTimeout(function () {
                                                BaseGenericJS.getContent("Home");
                                                MenuJS.closeLilWaitMessage();
                                             }, 1000);
                                          } else {
                                             MenuJS.closeLilWaitMessage();
                                             $('#algo').css({
                                                'border': '1px solid red'
                                             });
                                             return false;
                                          }
                                       }
                                    },
                                    cancelar: {
                                       label: "cerrar",
                                       className: 'btn-info',
                                    }
                                 }
                              });
                              console.log('parametros para options 1037 ');
                              FormularioJS.opciones.agregar('#motivo_rechazo', 'motivo_rechazo');
                              $('#motivo_rechazo').selectpicker({
                                 style: 'form-control btn btn-2017 ',
                                 size: 4,
                                 actionsBox: true,
                                 deselectAllText: 'Ninguno',
                                 dropupAuto: true,
                                 noneSelectedText: 'Seleccione',
                                 selectAllText: 'Todos'
                              });
                            });
                        });
                        $('button[name="Regresar"]').click(function (e) {
                            MenuJS.openLilWaitMessage();
                          $.when(FormularioJS.obtener.sobreEscrituraSheet()).then(function(response){
                            MenuJS.closeLilWaitMessage();
                            var regresar = {
                               Seguridad: 'AFG',
                               Viabilidad: 'Seguridad',
                               RRLL: 'Viabilidad',
                               Auditoria: 'RRLL',
                               Penal: 'Auditoria'
                            };
                            console.log('active', active, regresar[active]);
                            bootbox.dialog({
                               title: 'Regresar caso:',
                               message: "<p>Explica el motivo del rechazo del caso.</p><textarea id='algo' style='width: 100%'></textarea>",
                               size: 'large',
                               buttons: {
                                  rechazo: {
                                     label: "Regresar caso",
                                     className: 'btn-danger',
                                     callback: function () {
                                        valido = FormularioJS.validar.areas(regresar[active], 'Regresar');
                                        if ($('#algo').val() !== '') {
                                           FormularioJS.alasql.modificar(valido[1][0], fecha);
                                           FormularioJS.alasql.modificar(valido[1][1], 'Pendiente'); // O debería ser Rechazado? - Regresado?
                                           valido[1][2] ? FormularioJS.alasql.modificar(valido[1][2], '') : '';
                                           valido[1][3] ? FormularioJS.alasql.modificar(valido[1][3], '') : '';
                                           var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                                           var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                                           var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                                           if (data['N'].indexOf(',') !== -1) {
                                              data['N'] = escape(data['N']);
                                           }
                                           FormularioJS.sprdsheet.guardar(rango, Object.values(data).toString());
                                           FormularioJS.sprdsheet.guardar(null, [data['CK'], active, 'Rechazado', fecha, sessionStorage.NB_CORREO, $('#algo').val()].toString(), 'Estatus');
                                           FormularioJS.correos('Rechazado', data);
                                           setTimeout(function () {
                                              BaseGenericJS.getContent("Home");
                                              MenuJS.closeLilWaitMessage();
                                              FormularioJS.sprdsheet.guardar(null, [data['CK'], circuitoReversa[active], 'Pendiente', fecha, sessionStorage.NB_CORREO, 'Regresado'].toString(), 'Estatus');
                                           }, 1000);
                                        } else {
                                           MenuJS.closeLilWaitMessage();
                                           $('#algo').css({
                                              'border': '1px solid red'
                                           });
                                           return false;
                                        }
                                     }
                                  },
                                  cancelar: {
                                     label: "cerrar",
                                     className: 'btn-info',
                                  }
                               }
                            });
                          });
                        });
                        $('button[name="sinParticipacion"]').click(function (e) {
                            MenuJS.openLilWaitMessage();
                            $.when(FormularioJS.obtener.sobreEscrituraSheet()).then(function(response){
                              MenuJS.closeLilWaitMessage();
                              valido = FormularioJS.validar.areas(active, "Sin participación");
                              bootbox.dialog({
                                 title: 'Sin Participación en el caso:',
                                 message: "<p>Explica el motivo de no participar en el caso.</p><textarea id='algo' style='width: 100%'></textarea>",
                                 size: 'large',
                                 buttons: {
                                    rechazo: {
                                       label: "Sin Participación",
                                       className: 'btn-danger',
                                       callback: function () {
                                          if ($('#algo').val() !== '') {
                                             var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                                             var aclaraciones = active === 'Aclaraciones' ? "Aprobado" : 'Terminado';
                                             var circuitos = FormularioJS.validar.circuito(active);
                                             (active === 'Viabilidad') ? FormularioJS.alasql.modificar('BR', 'Aceptado'): '';
                                             FormularioJS.columnas[active][1] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][1], fecha) : '';
                                             FormularioJS.columnas[active][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], 'Terminado') : '';
                                             console.log('Circuitos-Sin participación: ', circuitos)
                                             circuitos.length !== 0 || active === 'RRLL' ? FormularioJS.correos(aclaraciones, data, active) : '';
                                             circuitos.forEach((circuito) => {
                                                if (circuito == 'Aclaraciones-Auditoria') {
                                                   circuito = 'Auditoria'
                                                };
                                                FormularioJS.columnas[circuito][0] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][0], fecha) : '';
                                                FormularioJS.columnas[circuito][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][2], 'Pendiente') : '';
                                             });
                                             var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                                             var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                                             var data = alasql('SELECT * REMOVE indice FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                                             if (data['N'].indexOf(',') !== -1) {
                                                data['N'] = escape(data['N']);
                                             }
                                             //FormularioJS.sprdsheet.guardar(rango, Object.values(data).toString());
                                             FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data).toString());
                                             FormularioJS.sprdsheet.guardar(null, [data['CK'], active, 'Sin Participación', fecha, sessionStorage.NB_CORREO, $('#algo').val()].toString(), 'Estatus');
                                             // FormularioJS.correos('Rechazado', data);
                                             setTimeout(function () {
                                                BaseGenericJS.getContent("Home");
                                                MenuJS.closeLilWaitMessage();
                                             }, 1000);
                                          }
                                       },
                                       cancelar: {
                                          label: "cerrar",
                                          className: 'btn-info',
                                       }
                                    }
                                 }
                              });
                            });
                        });
                        $('button[name="Guardar"]').click(function (e) {
                          console.log('button[name="Guardar"]  accion enviada ......');
                          MenuJS.openLilWaitMessage();
                          e.preventDefault();
                          e.stopPropagation();
                        $.when(FormularioJS.obtener.sobreEscrituraSheet()).then(function(response){
                            MenuJS.closeLilWaitMessage();
                            console.log('termino del deferred 2');
                            if ($('#cuestionario' + active).find('#fechaPresDenunciaJ').val() === '') {
                               return;
                            }
                            console.log('valida areas', active);
                            FormularioJS.validar.areas(active);
                            //console.log('data de session :::::',alasql('SELECT * REMOVE indice, undefined FROM transformaciones WHERE indice=' + FormularioJS.active)[0]);
                            var data = alasql('SELECT * REMOVE indice, undefined FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                            console.log('data despues de de mofiicar documentos' ,data);
                            var estatu = data[FormularioJS.columnas[active][2]];
                            console.log('1132 guardar estatus', estatu);
                            // (active === 'Penal') ? '' : FormularioJS.alasql.modificar(valido[1][0], '');
                            estatu = estatu === 'Pendiente' && active !== 'Penal' ?
                               'Asignado' :
                               estatu === 'Terminado' || active === 'Penal' ?
                               'Terminado' :
                               'En proceso';
                            // Envío de correos?
                            console.log('Estatus para enviar correos ****', estatu, '*******  sesion storage ', sessionStorage.id_puesto, '++++', data);
                            (estatu === 'Asignado' && sessionStorage.id_puesto !== '11') ? FormularioJS.correos(estatu, data, active): '';
                            // Si es afg y se asigna, entonces el caso entra al circuito
                            if (active === 'AFG' && (estatu === 'Asignado' || estatu === 'Pendiente')) {
                               var circuitos = FormularioJS.validar.circuito(active);
                               console.log('circuitos en guardar 1152 ::::', circuitos);
                               circuitos.length !== 0 ? FormularioJS.correos('Aprobado', data, active) : '';
                               circuitos.forEach((circuito) => {
                                  if (circuito == 'Aclaraciones-Auditoria') {
                                     circuito = 'Auditoria'
                                  };
                                  console.log('1195 circuito', circuito);
                                  FormularioJS.columnas[circuito][0] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][0], fecha) : '';
                                  FormularioJS.columnas[circuito][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][2], 'Pendiente') : '';
                               });
                            }
                            // Si es AFG - Quebranto y se sube la carta finiquito, y no ha pasado a auditoría, entonces se mueve
                            if (active === 'AFG' && sessionStorage.id_puesto === '11') {
                               console.log('circuitos 11 ::::::: ');
                               var circuitos = FormularioJS.validar.circuito('AFG2');
                               console.log(circuitos)
                               //circuitos.length !== 0 ? FormularioJS.correos('Aprobado', data, active) : '';
                               circuitos.length !== 0 ? FormularioJS.correos(estatu, data, 'AFG2') : '';
                               circuitos.forEach((circuito) => {
                                  if (circuito == 'Aclaraciones-Auditoria') {
                                     circuito = 'Auditoria'
                                  };
                                  console.log('forecah 1222', circuito);
                                  FormularioJS.columnas[circuito][0] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][0], fecha) : '';
                                  FormularioJS.columnas[circuito][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[circuito][2], 'Pendiente') : '';
                               });
                            }
                            // Si es penal....
                            if (active === 'Penal') {
                               FormularioJS.columnas[active][2] ? FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], 'Terminado') : '';
                            } else {
                               FormularioJS.alasql.modificar(FormularioJS.columnas[active][2], estatu);
                            }
                            data = alasql('SELECT * REMOVE indice, undefined FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                            var lastRow = HomeJS.numAColumn(alasql('SELECT ROW * REMOVE indice, undefined FROM transformaciones WHERE indice=' + FormularioJS.active).length);
                            var rango = 'A' + FormularioJS.active + ':' + lastRow + FormularioJS.active;
                            if (data['N'].indexOf(',') !== -1) {
                               data['N'] = escape(data['N']);
                            }
                            console.log('1176 guarda data', data);
                            FormularioJS.sprdsheet.guardar(rango, JSON.stringify(data).toString());
                            FormularioJS.sprdsheet.guardar(null, JSON.stringify({
                               A: data['CK'],
                               B: active,
                               C: estatu,
                               D: fecha,
                               E: sessionStorage.NB_CORREO
                            }), 'Estatus');
                            // console.log('El estatu', estatu)
                            //active === 'Aclaraciones' || active === 'Penal' || estatu === 'Terminado' ? '' : FormularioJS.correos(estatu, data, active);
                            //(active === 'Aclaraciones' && estatu === 'Terminado') || active !== 'Penal' || estatu === 'Asignado' ? '' : FormularioJS.correos(estatu, data, active);
                            // Mandar correo cuando Ya se llenó la carta finiquito
                            if (data['AC'] !== '' && sessionStorage.id_puesto === '8' && data['BA'] !== 'Pendiente') {
                               FormularioJS.correos('cartaFiniquito', data, 'AFG2');
                            }
                            setTimeout(function () {
                               BaseGenericJS.getContent("Home");
                               MenuJS.closeLilWaitMessage();
                            }, 1000);
                          });
                        });
                        // Ajustes Mal hechos y manuales al flujo
                        if (sessionStorage.id_puesto === '9' || sessionStorage.id_puesto === '3') { // Mostrar el botón de sin participación en RCI y RRLL
                           $('div[id*="cuestionario"]').find('button[name="sinParticipacion"]').removeClass('hide');
                        }
                        // Mostrar el botón de sin participación en el analista del caso de AFG
                        if (sessionStorage.id_puesto === '2' && datos['BA'] !== 'Terminado' && datos['BA'] !== 'Rechazado') {
                           $('div[id*="cuestionario"]').find('.botoneraAFG').removeClass('hide');
                           $('div[id*="cuestionario"]').find('button[name="sinParticipacion"]').removeClass('hide');
                        }
                        // Ajusets mal hechos al perfil de jurídico
                        if (active === 'Penal') {
                           $('div[id*="cuestionario"]').find('.botoneraPenal').removeClass('hide');
                           $('div[id*="cuestionario"]').find('button[name="Guardar"]').removeClass('hide');
                        }
                        // VISTA DE ADMIN ------------------------------
                        if (sessionStorage.id_puesto === '1') {
                           $('ul.nav-tabs li').removeClass('hide');
                           $('ul.nav-tabs').find('li#tabsAclaraciones').addClass('hide');
                           $('div[class*="botonera"]').removeClass('hide');
                           $('div[class*="botonera"] button').addClass('hide');
                           $('div.label-status').parent().addClass('hide');
                           $('div[id*="cuestionario"]').find('button[name="Reabrir"], button[name="Guardar"]').removeClass('hide');
                           FormularioJS.validar.archivos();
                        }
                     } else {
                        $('#form_areas').hide();
                        $('.btn_datos_generales').show();
                     }
                     break;
                  case 'AFG':
                  case 'RCI':
                  case 'Seguridad':
                  case 'RRLL':
                  case 'Viabilidad':
                  case 'Auditoria':
                  case 'Penal':
                  case 'Aclaraciones':
                     console.log('1248');
                     var valido = true;
                     var excluidos = ['caso', 'folio_audie', 'folio_faro'];
                     if (area === 'AFG' && $('#tipologia').val() === 'Consultas Injustificadas') {
                        $('#importe_quebranto').val(0);
                        $('#importe_recuperacion').val(0);
                     }
                     $('#cuestionario' + area + ' input, #cuestionario' + area + ' select').each((indx, campo) => {
                        if ($(campo).attr('columna') !== undefined) {
                           if ($(campo).val() === null && $(campo).find('option')) {
                              $(campo).val($(campo).find('option').eq(0).val());
                           }
                           alasql.tables.transformaciones.data[FormularioJS.active - 2][$(campo).attr('columna')] = $(campo).val() ? $(campo).val() : '';
                           if (($(campo).val() === null || $(campo).val() === '') && !excluidos.includes($(campo).attr('id'))) {
                              valido = false;
                           }
                        }
                     });
                     var obligados = []
                     if ($('#form_documentos').children('div:not(.hide)').children('div[obligatorio="true"]').length !== 0) {
                        valido = false;
                        $('#form_documentos').children('div:not(.hide)').children('div[obligatorio="true"]').each((indx, obligado) => {
                           obligados.push($(obligado).parent().find('label').html());
                        });
                     }
                     var documentosMSG = '';
                     if (obligados.length !== 0) {
                        documentosMSG = '<div class="alert alert-danger">Documento Obligatorio: '
                        documentosMSG += obligados.join('<br />Documento Obligatorio: ');
                        documentosMSG += '</div>';
                     }
                     MenuJS.openLilWaitMessage();
                     return [valido, documentosMSG];
                     break;
               }
            },
            archivos: function () {
               var archivos = FormularioJS.edit === true ? alasql('SELECT * FROM transformaciones WHERE indice=' + FormularioJS.active)[0] : FormularioJS.aGuardar,
                  etapa = FormularioJS.edit === true ? sessionStorage.id_puesto !== "7" ? CasosJS.obtenerEstatusAclaraciones(FormularioJS.active) : {
                     area: 'Alta',
                     estatus: "Pendiente"
                  } : {
                     area: 'Alta',
                     estatus: "Pendiente"
                  },
                  puesto = alasql('SELECT ROW nb_area FROM (SELECT * FROM usuarios JOIN puesto_area USING id_puesto JOIN area USING id_area WHERE email="' + sessionStorage.NB_CORREO + '")')[0];
               etapa.area = FormularioJS.edit === true ? etapa.area !== puesto && sessionStorage.id_puesto !== '10' ? puesto : etapa.area : etapa.area;

               var btnQuitar = '<span class="btn glyphicon glyphicon-remove btnQuitar site-tooltipFiles" style="color: #dc3545;" data-toggle="tooltip" aria-describedby="tooltip" data-original-title="Eliminar el archivo"></span>',
                  btnSolicitar = '<span id="btnSolicitar" class="btn glyphicon glyphicon-unchecked site-tooltipFiles" data-toggle="tooltip" aria-describedby="tooltip" data-original-title="Solicitar original del archivo"></span>'; // glyphicon-check
               var permisoArchivos = alasql('SELECT * FROM area JOIN archivo_area USING id_area JOIN archivo USING id_archivo WHERE nb_area = "' + etapa.area + '"').map((archivo) => archivo["nb_archivo"]),
                  obligatorio = alasql('SELECT UNIQUE nb_archivo FROM (SELECT * FROM archivo JOIN archivo_area USING id_archivo JOIN area USING id_area) WHERE nb_area = "' + etapa.area + '" && obligatorio = 1').map((archivo) => archivo["nb_archivo"]),
                  editable = alasql('SELECT UNIQUE nb_archivo FROM (SELECT * FROM archivo JOIN archivo_area USING id_archivo JOIN area USING id_area) WHERE nb_area = "' + etapa.area + '" && editable = 1').map((archivo) => archivo["nb_archivo"]),
                  original = alasql('SELECT * remove indice FROM originales WHERE Folio = "' + archivos['CK'] + '"')[0];

               var originales = original === undefined ? [] : alasql('SELECT nb_archivo FROM archivo AS files JOIN ? AS original ON files.id_archivo = original.[1]', [original]).map((file) => file.nb_archivo);

               if (archivos['AR'] === 'Consultas Injustificadas') {
                  permisoArchivos = permisoArchivos.filter((archivo) => archivo !== 'Informe Seguridad');
                  obligatorio = obligatorio.filter((archivo) => archivo !== 'Informe Seguridad');
               } else {
                  permisoArchivos = permisoArchivos.filter((archivo) => archivo !== 'Informe RCI');
               }

               if (sessionStorage.id_puesto === '11') { // Para el perfil de AFG - quebranto
                  permisoArchivos = ['Cédula de quebranto', 'Carta finiquito'];
                  obligatorio = ['Cédula de quebranto'];
                  editable = ['Cédula de quebranto'];
               }
               $('#form_documentos').find('label').each(function (indx, label) {
                  $(label).parent().find('div').remove();
                  $(label).parent().find('a').remove();
                  $(label).parent().find('span').remove();
                  // Asignando archivos
                  if (permisoArchivos.includes($(label).html()) || sessionStorage.id_puesto === '1') { // Si lo incluye
                     if ((editable.includes($(label).html()) && (etapa.estatus !== 'Terminado' || sessionStorage.id_puesto === '11') && etapa.estatus !== 'Rechazado') || sessionStorage.id_puesto === '1') { // Si es editable
                        if (sessionStorage.id_puesto === '1') {
                           $(label).parent().removeClass('hide');
                        }
                        if (archivos[$(label).attr('columna')] !== '') { // Si existe el archivo y es editable
                           var append = '<a class="btn label-status lbl-success ver site-tooltipFile" href="' + archivos[$(label).attr('columna')] + '" target="_blank">Abrir documento</a>' + btnQuitar + (['Auditoria', 'Penal'].includes(etapa.area) ? btnSolicitar : '');
                           append = originales.includes($(label).html()) ? append.replace('glyphicon-unchecked', 'glyphicon-check') : append;
                           $(label).parent().append(append);
                        } else { // Si no existe el archivo y es editable
                           var append = '<div class="btn label-status btn-primary site-tooltipFile" obligatorio="' + (obligatorio.includes($(label).html()) ? 'true' : 'false') + '">Subir documento</div>';
                           $(label).parent().append(append);
                           //obligatorio.includes($(label).html()) ? $(label).parent().attr('obligatorio', "true") : '';
                        }
                     } else { // si no es editable}
                        if (archivos[$(label).attr('columna')] !== '') { // Si existe el archivo y no es editable
                           //$(label).parent().append('<div class="label-status lbl-success">Con documento</div>');
                           var append = '<a class="btn label-status lbl-success ver site-tooltipFile" href="' + archivos[$(label).attr('columna')] + '" target="_blank">Abrir documento</a>' + (['Auditoria', 'Penal'].includes(etapa.area) ? btnSolicitar : '');
                           append = originales.includes($(label).html()) ? append.replace('glyphicon-unchecked', 'glyphicon-check disabled') : append;
                           $(label).parent().append(append);
                        } else { // Si no existe el archivo y no es editable
                           $(label).parent().append('<div class="label-status lbl-secundary site-tooltipFile" data-toggle="tooltip" data-original-title="Documento depende de ' + $(label).attr('origen') + '">No hay documento</div>');
                        }
                     }
                  } else {
                     $(label).parent().addClass('hide');
                  }
               });
               // Eventos del click
               $('#form_documentos')
                  .children('div:not(.hide)')
                  .children('div.btn')
                  .on("click", (e) => {
                     var nombreArchivo = $(e.target).parent().find('label').html() + '_' + $(e.target).parent().find('label').attr('columna');
                     FormularioJS.archivos.subir(nombreArchivo);
                  });
               $('#form_documentos')
                  .children('div:not(.hide)')
                  .children('span.btnQuitar')
                  .on("click", (e) => {
                     $(e.target).unbind();
                     var columna = $(e.target).parent().find('label').attr('columna');
                     if (FormularioJS.edit) {
                        FormularioJS.alasql.modificar(columna, '');
                     } else {
                        FormularioJS.aGuardar[columna] = '';
                     }
                     FormularioJS.validar.archivos();
                  });
               $('#form_documentos')
                  .children('div:not(.hide)')
                  .children('span#btnSolicitar:not(.disabled)')
                  .on("click", (e) => {
                     //$(e.target).unbind();
                     if ($(e.target).hasClass('disabled')) {
                        return;
                     }
                     var archv = alasql('SELECT ROW id_archivo FROM archivo WHERE nb_archivo = "' + $(e.target).parent().find('label').html() + '"')[0];
                     if (alasql('SELECT * FROM originales WHERE Folio = "' + archivos['CK'] + '"').length === 0) {
                        var añadir = {
                           1: "",
                           2: "",
                           3: "",
                           4: "",
                           5: "",
                           6: "",
                           7: "",
                           8: "",
                           9: "",
                           10: "",
                           11: "",
                           12: "",
                           13: "",
                           14: "",
                           15: "",
                           16: "",
                           17: "",
                           Folio: archivos['CK'],
                           indice: alasql('SELECT * FROM originales').length + 2
                        }
                        alasql('INSERT INTO originales SELECT * FROM ?', [
                           [añadir]
                        ]);
                     }
                     // Modificando
                     alasql('UPDATE originales SET [' + archv + '] = ' + archv + ' WHERE Folio = "' + archivos['CK'] + '"');
                     // Guardando
                     var indicador = alasql('SELECT ROW indice FROM originales WHERE Folio = "' + archivos['CK'] + '"')[0];
                     var paraGuardar = alasql('SELECT Folio AS 0, [1], [2], [3], [4], [5], [6], [7], [8], [9], [10], [11], [12], [13], [14], [15], [16], [17]  FROM originales WHERE Folio = "' + archivos['CK'] + '"');
                     google.script.run.withSuccessHandler(function (response) {
                        console.log('SpreadSheet Guardado');
                     }).withFailureHandler(GenericJS.setFailure).transformacionesSaveSpreadSheet(('A' + indicador + ':R' + indicador), JSON.stringify(paraGuardar), 'originales');
                     // Enviando Correo
                     var perfilUsuario = $(e.target).parent().find('label').attr('origen');
                     FormularioJS.correos('pedirDocumento', archivos, perfilUsuario, $(e.target).parent().find('label').html(), etapa.area);
                     // Eventos
                     $(e.target).addClass('glyphicon-check');
                     $(e.target).removeClass('glyphicon-unchecked');
                     $(e.target).addClass('disabled');
                  });
               $(".site-tooltipFiles").tooltip({
                  //placement: "top",
                  trigger: "hover",
                  animation: true,
                  html: true
               });
            },
            caracteres: function () {
               $('input').unbind();
               $('input').on("input", function (e) {
                  e.stopPropagation();
                  if (!$(this).attr('pattern') && !$(this).attr('maxlength') && $(this).val() !== '') {
                     return 0;
                  }
                  var regex = $(this).attr('pattern') ? $(this).attr('pattern').split(', ')[0] : "/(.*)/g",
                     replaces = $(this).attr('pattern') ? $(this).attr('pattern').split(', ')[1] : '$1',
                     maxlength = $(this).attr('maxlength') ? $(this).attr('maxlength') : $(this).val().length,
                     valor = $(this).val();
                  valor = valor.replace(new RegExp(regex), replaces);
                  valor = valor.slice(0, maxlength)
                  $(this).val(valor);
               });
               $('.avisos_not_found input, .avisos_not_found select, .avisos_not_found textarea').on("change", function () {
                  if ($(this).attr("columna")) {
                     var columnaConGuion = $(this).attr('columna'),
                        columna = $(this).attr('columna').replace('_', '').replace('-', ''),
                        nombres = [],
                        porcentaje = ['_F', '_I', '_H', '_K'].includes(columnaConGuion) ? 0 : 3;
                     if ($(this).attr('columna').indexOf('_') !== -1) {
                        if ($(this).attr("id") === "descripcion1" || $(this).attr("id") === "descripcion2") {
                           FormularioJS.actualizarDescripcion();
                        } else {
                           $('[columna="' + columnaConGuion + '"]').each((indx, este) => nombres.push($(este).val() + ' '));
                           $('[columna="' + columna + '-"]').each((indx, este) => nombres.push(!(indx % porcentaje) ? ' || ' + $(este).val() : ' ' + $(este).val()));
                           $('[columna="' + columna + '"]').val(nombres.join('').toUpperCase().toUpperCase());
                        }
                     } else if ($(this).attr('columna').indexOf('-') !== -1) {
                        $('[columna="_' + columna + '"]').each((indx, este) => nombres.push($(este).val() + ' '));
                        $('[columna="' + columnaConGuion + '"]').each((indx, este) => nombres.push(!(indx % porcentaje) ? ' || ' + $(este).val() : ' ' + $(este).val()));
                        $('[columna="' + columna + '"]').val(nombres.join('').toUpperCase());
                     } else {
                        $(this).attr('id') === 'tarjetaCliente_' ? FormularioJS.aGuardar[$(this).attr("columna")] = ('0000000000' + $(this).val()).slice(-10) : FormularioJS.aGuardar[$(this).attr("columna")] = $(this).val();
                        // combo de productos cambio de taributos alinput tarjetaCliente_
                        if ($(this).attr('id') === 'producto') {
                           console.log($(this).val())
                           $('label[for="tarjetaCliente_"]').html('Número de ' + $(this).val());
                           if ($(this).val() === 'Tarjeta de Debito' || $(this).val() === 'Tarjeta de Crédito') {
                              $('input#tarjetaCliente_').val('').attr('maxlength', '16');
                           } else if ($(this).val() === 'Tarjeta de Débito') {
                              $('input#tarjetaCliente_').val('').attr('maxlength', '16');
                           } else if ($(this).val().indexOf('Préstamo') !== -1) {
                              $('input#tarjetaCliente_').val('').attr('maxlength', '10');
                           }
                        }
                     }
                  }
                  // Revisando si tiene los clientes o empleados llenos para mostrar los botones de más
                  var llenoClientes = true;
                  $('#form_cliente input').each((indx, este) => este.value === '' ? llenoClientes = false : '');
                  llenoClientes === true ? $('#form_cliente .btns').removeClass('hide') : $('#form_cliente .btns').addClass('hide');
                  var llenoEmpleados = true;
                  $('#form_empleado input').each((indx, este) => este.value === '' ? llenoEmpleados = false : '');
                  llenoEmpleados === true ? $('#form_empleado .btns').removeClass('hide') : $('#form_empleado .btns').addClass('hide');
               });
            }
         },

         correos: function (cual, data, active, documento, area) {
            console.log('parametros para Correos:  cual , data ,active ,documentos ,area', cual, data, active, documento, area);
            data = data ? data : alasql('SELECT * FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
            // Si no viene el nombre del cliente
            /*FormularioJS.sprdsheet.conFiltro('Clientes', 7, data['CK']).then(function (texto) {
              //if (data['G'] === '') {
                var clientes = alasql('SELECT TOP 1 * FROM clientes WHERE G AND CK="' + data['CK'] + '"')[0];
                var empleados = alasql('SELECT TOP 1 * FROM clientes WHERE F AND CK="' + data['CK'] + '"')[0];
                data['G'] = clientes['G'];
                data['F'] = empleados['F'];
              //}*/
            var mensaje = {
               to: '',
               cc: '',
               bcc: [].join(', '),
               reply: 'no-reply',
               subject: '[subject - Site Bitácora 2.0]',
               mensajeHtml: '<div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                  '<span style="color:#696969;font-weight:normal">FOLIO:</span>' +
                  '</div><div style="margin-bottom:10px;text-align: left;"><a href="https://script.google.com/a/bbva.com/macros/s/AKfycbx5zc3p36pQHUJ0SlrdyH50t2_TbERLEDufKJgVemm9Q6Dl6z-E/exec?i=' + FormularioJS.active + '" target="_blank" >' + data['CK'] +
                  '</a></div><div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                  '<span style="color:#696969;font-weight:normal">CLIENTE:</span>' +
                  '</div><div style="margin-bottom:10px;text-align: left;">' + data['F'] + ' | ' + data['G'] +
                  '</div><div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                  '<span style="color:#696969;font-weight:normal">FECHA DEL INCIDENTE:</span>' +
                  '</div><div style="margin-bottom:10px;text-align: left;">' + data['C'] +
                  '</div><div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                  '<span style="color:#696969;font-weight:normal">MONTO:</span>' +
                  '</div><div style="margin-bottom:10px;text-align: left;">' + commaSeparateNumber(data['D']) + 'MXN' +
                  '</div><div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                  '<span style="color:#696969;font-weight:normal">REPORTADO POR:</span>' +
                  '</div><div style="margin-bottom:10px;text-align: left;">' + sessionStorage.NB_CORREO + ' | CR: ' + data['O'] +
                  '</div>'

            };
            switch (cual) {
               /*case 'Alta':
                 mensaje.to = CorreoJS.validarPuestos(parseInt(sessionStorage.id_puesto), "Alta").join(', ');
                 mensaje.subject = mensaje.subject.replace('subject', 'Alta de caso');
               break;*/
               case 'Guardar':
                  mensaje.to = CorreoJS.validarPuestos(parseInt(sessionStorage.id_puesto), "Aprobado").join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' Actualizado');
                  return;
                  break;
               case 'Reabrir':
                  mensaje.to = CorreoJS.validarPuestos(parseInt(sessionStorage.id_puesto), "Reabierto").join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' Reabierto');
                  break;
               case 'Asignado':
                  mensaje.to = data[FormularioJS.columnas[active][3]];
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' para revisión');
                  break;
               case 'Aprobado':
               case 'Terminado':
               case 'Alta':
                  console.log('El Terminado');
                  //debugger;
                  var correoCircuito = [];
                  // console.log(FormularioJS.validar.circuito(active), active);
                  FormularioJS.validar.circuito(active).forEach((circuito) => {
                     console.log('1531 - circuito', circuito);
                     var idArea = alasql('SELECT ROW id_puesto FROM puesto WHERE nb_puesto LIKE "%' + circuito + '$"')[0];
                     console.log('1532 - idArea', idArea);
                     correoCircuito.push(CorreoJS.validarPuestos(idArea, "Obtener").join(', '));
                     console.log('1534 - correoCircuito', correoCircuito);
                     // Agregando el perfil 10, Viabildiad - Penal
                     if (circuito === 'Viabilidad' || circuito === 'Penal') {
                        var idArea = alasql('SELECT ROW id_puesto FROM puesto WHERE nb_puesto LIKE "%Viable-Penal$"')[0];
                        correoCircuito.push(CorreoJS.validarPuestos(idArea, "Obtener").join(', '));
                     }
                     if (circuito === 'Seguridad' && (data["AR"] == 'Fraude Consumado < 100,000' || data["AR"] == 'Fraude Consumado > 100,000' || data["AR"] == 'Fraude Consumado > 3,000,000')) {
                        correoCircuito.push(CorreoJS.validarPuestos(8, "Obtener").join(', '));
                     }
                     //notificacion cuando sea monto mayor a 3,000,000
                     var monto = alasql('SELECT D AS [monto], AR as [tipologia] FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                     console.log('validacion de correo a audtoria mayor a 3M', monto.monto, circuito, sessionStorage.id_puesto, sessionStorage.titular, monto.tipologia);
                     if (Number(monto.monto) >= 3000000 && circuito === 'Seguridad' && sessionStorage.id_puesto == 2 && sessionStorage.titular == 1 && monto.tipologia == 'Fraude Consumado > 3,000,000') {
                        correoCircuito.push(CorreoJS.validarPuestos(6, "Obtener").join(', '));
                     }
                  });
                  console.log('correoCircuito 1576', correoCircuito);
                  correoCircuito = correoCircuito.filter((correoC) => correoC !== '');
                  console.log('correoCircuito 1578', correoCircuito);
                  mensaje.to = correoCircuito.join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' para revisión');
                  break;
               case 'Rechazado':
                  var motivoRechazo = alasql('SELECT Observaciones FROM estatus WHERE [# Folio] = "' + data['CK'] + '" AND Estatus = "Rechazado"').map((observacion) => observacion.Observaciones).join(' <br /> + ');
                  mensaje.mensajeHtml += '<div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                     '<span style="color:#696969;font-weight:normal">Rechazo:</span>' +
                     '</div><div style="margin-bottom:10px;text-align: left;">' + motivoRechazo + '</div>';
                  //mensaje.to = CorreoJS.validarPuestos(parseInt(sessionStorage.id_puesto), "Aprobado").join(', ');
                  mensaje.to = alasql('SELECT ROW TOP 1 Usuario FROM estatus WHERE [# Folio] === "' + data['CK'] + '" && Estatus === "Pendiente"')[0];
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' Rechazado');
                  break;
               case 'cartaFiniquito':
                  mensaje.to = CorreoJS.validarPuestos(11, "Aprobado").join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' con carta finiquito');
                  break;
               case 'sincartaFiniquito':
                  mensaje.to = CorreoJS.validarPuestos(11, "Aprobado").join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' sin carta finiquito');
                  break;
               case 'pedirDocumento':
                  var idArea = alasql('SELECT ROW id_puesto FROM puesto WHERE nb_puesto LIKE "%' + active + '$"')[0];
                  mensaje.to = CorreoJS.validarPuestos(idArea, "Aprobado").join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Caso ' + data['CK'] + ' Petición de documento original');
                  mensaje.mensajeHtml = '<div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                     '<span style="color:#696969;font-weight:normal">Docuemnto:</span>' +
                     '</div><div style="margin-bottom:10px;text-align: left;">' + documento + '</div><div style="width:230px;float:left;margin-bottom:10px;margin-right: 10px;text-align: right;">' +
                     '<span style="color:#696969;font-weight:normal">Para el área:</span>' +
                     '<div style="margin-bottom:10px;text-align: left;">' + active + '</div>';
                  break;
               case 'Entrada':
               default:
                  mensaje.to = CorreoJS.validarPuestos(parseInt(sessionStorage.id_puesto), "Aprobado").join(', ');
                  mensaje.subject = mensaje.subject.replace('subject', 'Alta de caso');
                  break;
            }
            if (active === 'RRLL' && cual === 'Terminado') {
               mensaje.to += (mensaje.to !== '' ? ', ' : '') + alasql('SELECT * FROM usuarios WHERE id_puesto = 2 AND titular = 1').map((correos) => correos.email).join(', ');
            }
            mensaje.cc = mensaje.to;
            //mensaje.to = 'joseluis.murillo.garcia.contractor@bbva.com, santiago.verda.contractor@bbva.com'; // quitar
            //mensaje.cc = [].join(', '); // quitar
            console.dir('Mensaje.TO: ' + mensaje.to);
            console.dir('mensaje.HTML' + mensaje.mensajeHtml);
            //gioR comente linea elimnar correo
            //CorreoJS.enviarCorreo(mensaje);
         },

         archivos: {
            clientEmpleado: function (clientesEmpleados) {
               var ligaDescarga = clientesEmpleados === 'cliente' ? 'https://drive.google.com/a/bbva.com/uc?authuser=0&id=1XG4u2w2bR6GcV_6fGvml2c3UXjN-L8Qb&export=download' : 'https://drive.google.com/a/bbva.com/uc?authuser=0&id=1itTsbkVktu0i0IA4xp-MSbwww0ke0WSR&export=download';
               bootbox.dialog({
                  title: ('Subir Archivo: ' + clientesEmpleados),
                  message: '<div class="row"><div class="col-md-12" style="padding-top:20px"><p><a href="' + ligaDescarga + '" target="_blank">Descargar Layout</a></p><input type="file" id="carga_clientEmpleado" class="filestyle" data-btnclass="btn btn_Nuevo_Examninar" data-buttonbefore="true" data-text="Carga de archivo" data-placeholder="Únicamente archivo algo" accept=".xlsx" tabindex="-1" style="position: absolute; clip: rect(0px, 0px, 0px, 0px);"></div><div class="col-md-12" id="informacionArchivoClientEmpleado"></div></div>',
                  size: 'large',
                  buttons: {
                     guardar: {
                        label: "Subir Archivo",
                        className: 'btn-primary',
                        callback: function () {
                           var tiposArchivo = ['xlsx'];
                           continuar = true;
                           $.each($('#carga_clientEmpleado')[0].files, (indx, input) => {
                              if (!tiposArchivo.includes(input.name.split('.')[1].toLowerCase())) {
                                 $('#informacionArchivoClientEmpleado').html('El archivo sólo puede incluir tipos de archivo: ' + tiposArchivo.join(', '));
                                 $('#carga_clientEmpleado').parent().children('div').addClass('has-error');
                                 continuar = false;
                              }
                           });
                           if (continuar === false) {
                              return false;
                           }
                           $.each($('#carga_clientEmpleado')[0].files, (indx, input) => {
                              var reader = new FileReader();

                              reader.onload = function (e) {
                                 /* convert data to binary string */
                                 var data = new Uint8Array(reader.result);

                                 var arr = new Array();
                                 for (var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
                                 var bstr = arr.join("");

                                 /* Call XLSX */
                                 var workbook = XLSX.read(bstr, {
                                    type: "binary"
                                 });
                                 /* DO SOMETHING WITH workbook HERE */
                                 var first_sheet_name = workbook.SheetNames[0];
                                 /* Get worksheet */
                                 var worksheet = workbook.Sheets[first_sheet_name];

                                 var arrayInicial = XLSX.utils.sheet_to_json(worksheet, {
                                    raw: false,
                                    header: 1
                                 });
                                 var fh = new Date();
                                 var arrayFinal = [];

                                 for (var i = 1; i < arrayInicial.length; i++) {
                                    if (arrayInicial[i].length !== 0) {
                                       arrayFinal.push(arrayInicial[i]);
                                    }
                                 }
                                 //console.log(arrayFinal);
                                 FormularioJS.validar.clientEmpleados(clientesEmpleados, arrayFinal);
                              }
                              reader.readAsArrayBuffer(input);
                           });
                        }
                     }
                  }
               });
               $("#carga_clientEmpleado").filestyle({
                  btnClass: "btn btnNuevoExamninar",
                  buttonBefore: true,
                  text: "Buscar",
                  placeholder: "Únicamente archivo ...",
                  'onChange': function (files, event) {
                     console.dir('Revisar archivo');
                  }
               });
            },
            subir: function (nombreArchivo) {
               console.log('subir archivo');
               var tiposArchivo = ['png', 'jpg', 'pdf', 'docx', 'mp4'];
               bootbox.dialog({
                  title: ('Subir Archivo: ' + nombreArchivo.split('_')[0]),
                  message: '<div class="row"><div class="col-md-12" style="padding-top:20px"><input type="file" multiple="multiple" id="carga_Archivo" class="filestyle" data-btnclass="btn btn_Nuevo_Examninar" data-buttonbefore="true" data-text="Carga de archivo" data-placeholder="Únicamente archivo algo" accept=".' + tiposArchivo.join(', .') + '" tabindex="-1" style="position: absolute; clip: rect(0px, 0px, 0px, 0px);"></div><div class="col-md-12" id="informacionArchivoCasos"></div></div>',
                  size: 'large',
                  buttons: {
                     guardar: {
                        label: "Subir Archivo",
                        className: 'btn-primary',
                        callback: function () {
                           continuar = true;
                           $.each($('#carga_Archivo')[0].files, (indx, input) => {
                              console.log('archivo cargadando ....', input);
                              if (!tiposArchivo.includes(input.name.split('.')[1].toLowerCase())) {
                                 $('#informacionArchivoCasos').html('El archivo sólo puede incluir tipos de archivo: ' + tiposArchivo.join(', .'));
                                 $('#carga_Archivo').parent().children('div').addClass('has-error');
                                 continuar = false;
                              }
                           });
                           console.log('continuar ', continuar);
                           if (continuar === false) {
                              return false;
                           }
                           $.each($('#carga_Archivo')[0].files, (indx, input) => {
                              var reader = new FileReader();
                              reader.onloadend = function () {
                                 // console.log(reader.result);
                                 var contenido = reader.result.split(',');
                                 var content = contenido[1],
                                    type = contenido[0].split(':')[1].split(';')[0];
                                 google.script.run.withSuccessHandler(function (response) {
                                    console.dir('Archivo Guardado', response);
                                    //bootbox.hideAll();
                                    MenuJS.closeLilWaitMessage();
                                   // debugger;
                                    if (FormularioJS.edit) {
                                       FormularioJS.alasql.modificar(nombreArchivo.split('_')[1], response);
                                    } else {
                                       FormularioJS.aGuardar[nombreArchivo.split('_')[1]] = response;
                                    }
                                    FormularioJS.validar.archivos();
                                 }).withFailureHandler(GenericJS.setFailure).subirArchivo(nombreArchivo + '_' + indx, content, type, FormularioJS.folio.obtener());
                              }
                              reader.readAsDataURL(input);
                              MenuJS.openLilWaitMessage();
                           });
                        }
                     }
                  }
               });
               $("#carga_Archivo").filestyle({
                  btnClass: "btn btnNuevoExamninar",
                  buttonBefore: true,
                  text: "Buscar",
                  placeholder: "Únicamente archivo ...",
                  'onChange': function (files, event) {
                     console.dir('Revisar archivo 1');
                  }
               });
            }
         },

         folio: {
            generar: function (usuarios, numeros, ceros) {
               console.log('generar folio :  ', usuarios, numeros, ceros);
               var cero = ceros ? ceros : 5,
                  numero = numeros ? numeros.toString() : FormularioJS.active.toString(),
                  usuario = usuarios ? usuarios.toString() : alasql('SELECT ROW nb_puesto FROM puesto WHERE id_puesto=' + sessionStorage.id_puesto).toString();
               console.log('cero,numero y usuario:  ', cero, numero, usuario);
               while (numero.length < cero) {
                  numero = '0' + numero;
               }
               console.log('folio generado', usuario.toUpperCase().slice(0, 3) + numero);
               return usuario.toUpperCase().slice(0, 3) + numero;
            },
            obtener: function (aBuscar) {
               if (FormularioJS.edit) {
                  return alasql('SELECT ROW CK FROM transformaciones WHERE indice=' + FormularioJS.active).join('');
               }
               return FormularioJS.aGuardar['CK'];
            }
         },

         rellenar: function (indice) {
            console.log('rellenar formulario 1806 de todos loas campos ', indice);
            indice = indice ? indice : FormularioJS.active;
            var datos = FormularioJS.alasql.obtener(indice),
               estatus = CasosJS.obtenerEstatusAclaraciones(indice),
               //obtiene los datos de la base dependiendo el indice
               caso = alasql('SELECT * FROM transformaciones WHERE indice = ' + indice)[0];
            //manda el tabla ,7, numero de folio
            FormularioJS.sprdsheet.conFiltro('Clientes', 7, caso['CK']).then(function (texto) {
               // alasql('SELECT * FROM transformaciones JOIN clientes JOIN clientes AS empleados ON clientes.CK && empleados.CK IN transformaciones.CK WHERE clientes.F && empleados.K')
               var clientes = alasql('SELECT * FROM clientes WHERE F'),
                  empleados = alasql('SELECT * FROM clientes WHERE K');
               // estatus.area = estatus.estatus === 'Terminado' ? "RRLL" : estatus.area;
               // *******  Rellenar la vista de edición ***************************
               var contador = 0;
               datos.forEach((dato, indx) => {
                  //console.log('contador',contador++);
                  //console.log('rellenar vista de edicion con dato 1882',dato);
                  //console.log('numero de columna del excel', HomeJS.numAColumn(indx + 1));
                  var input = 'input[columna="' + HomeJS.numAColumn(indx + 1) + '"]',
                     select = 'select[columna="' + HomeJS.numAColumn(indx + 1) + '"]';
                  $(input) ? $(input).val(dato) : '';
                  $(select) ? $(select).val(dato) : '';
               });
               //@gio mostrar el quebranto por que no se guarda en el excel
               $(function mostrarQuebrantoFormulario() {
                  var quebranto = $('#importe_quebranto').val(),
                     recuperacion = $('#importe_recuperacion').val();
                  $('#importe_total').val(quebranto - recuperacion).attr('disabled', 'disabled');
               });
               // Vista de edición para los usuarios y empleados
               //console.log('Revisar los empleados: ', empleados);
               //console.log('Revisar los clientes: ', clientes);
               // Rellenar la vista de reporte
               datos = caso;
               $('label[id*="v_"]').each(function (indx, label) {
                  var column = $(label).attr('columna').split(','),
                     columnas = [],
                     colCount = 0,
                     colIndc = 0,
                     etiqueta = [];
                  column.forEach((columna, indc) => {
                     columnas.push(datos[columna].toString().trim().split(' || '));
                     colCount = colCount < columnas[indc].length ? columnas[indc].length : colCount;
                  });
                  while (colIndc < colCount) {
                     if (datos[column[colIndc]] === '') {
                        $(label).parent().parent().addClass('hide');
                     } else {
                        !etiqueta[colIndc] ? etiqueta[colIndc] = '' : '';
                        columnas.forEach((columna, indx) => {
                           columna[colIndc] = columna[colIndc] === 'dg_areas_centrales' ?
                              'Áreas Centrales' :
                              columna[colIndc] === 'dg_territoriales' ?
                              'Territoriales' :
                              columna[colIndc] === 'etapa_procesal_abreviado' ?
                              'Abreviado' :
                              columna[colIndc] === 'etapa_procesal_largo' ?
                              'Largo' :
                              columna[colIndc];
                           etiqueta[colIndc] += (indx !== 0 ? '<span>|</span>' : '') + (column[colIndc] === 'O' ? 'CR: ' : '') + (columna[colIndc] ? (column[colIndc] === 'D' ? commaSeparateNumber(columna[colIndc]) : columna[colIndc]) : '') + (column[colIndc] === 'D' ? ' MXN' : '');
                        });
                     }
                     colIndc += 1;
                  }
                  var camposAclaraciones = ['v_folio', 'v_numAclaracion', 'v_fechaAlta', 'v_fechaIncidente', 'v_area', 'v_cr_afectado', 'v_sucursal', 'v_division', 'v_cuentaCliente', 'v_producto', 'v_tarjetaCliente', 'v_nombreCliente', 'v_empleado', 'v_descripcion', 'v_status'];
                  if (sessionStorage.id_puesto === '8' && !camposAclaraciones.includes($(label).attr('id'))) {
                     $(label).parent().parent().addClass('hide');
                  } else {
                     $(label).html(etiqueta.join('<br />+ ').replace(/\|\|/g, '<br />+ ').trim());
                  }
               });
               // Agregando clientes y empleados

               if (clientes.length > 1) {
                  var clntNombre = clientes.map((cliente) => cliente['F'] + ' | ' + cliente['G']);
                  var clntCuenta = clientes.map((cliente) => cliente['I']);
                  var clntProducto = clientes.map((cliente) => cliente['H']);
                  $('label#v_nombreCliente').html(clntNombre.join('<br/>'));
                  $('label#v_cuentaCliente').html(clntCuenta.join(', '));
                  $('label#v_producto').html(caso['E'] + ' | ' + clntProducto.join(', '));
               }
               if (empleados.length > 1) {
                  var empldNombre = empleados.map((empleado) => empleado['K'] + ' | ' + empleado['L']);
                  $('label#v_empleado').html(empldNombre.join('<br />'));
               }
               // Agregando el estatus
               $('#v_status').html(estatus.area + ' - ' + estatus.estatus).parent().parent().removeClass('hide');
               // Agregando Rechazos
               if (estatus.estatus === 'Rechazado' || caso['BR'] === 'Rechazado') {
                  var rechazos = alasql('SELECT Observaciones FROM estatus WHERE [# Folio]="' + datos['CK'] + '" AND (Estatus="Rechazado" OR BR = "Rechazado")').map((observacion) => observacion.Observaciones)
                  $('#v_rechazos').html(rechazos.join(' <br />+ ')).parent().parent().removeClass('hide');
               }
               // Sin participación
               var rechazos = alasql('SELECT Area, Observaciones FROM estatus WHERE [# Folio]="' + datos['CK'] + '" AND Estatus="Sin Participación"').map((observacion) => observacion.Area + ' - ' + observacion.Observaciones);
               rechazos.length != 0 ? $('#v_sinparticipacion').html(rechazos.join(' <br />+ ')).parent().parent().removeClass('hide') : '';

               // Viabilidad
               var viable = alasql('SELECT Area, Observaciones FROM estatus WHERE [# Folio]="' + datos['CK'] + '" AND Estatus="Viable"').map((observacion) => observacion.Area + ' - ' + observacion.Observaciones);
               viable.length != 0 ? $('#v_viabilidad').html(viable.join(' <br />+ ')).parent().parent().removeClass('hide') : '';
               MenuJS.closeLilWaitMessage();
               console.log('selects');
               try {
                  $('select').change().selectpicker('refresh');
               } catch (error) {
                  console.log('select no se auctualizo');
               }
            });
         },

         obtener: {
            vigencia: function (area, indice) {
               indice = indice ? indice : FormularioJS.active;
               area = area ? area : CasosJS.obtenerEstatusAclaraciones(indice).area;
               const datos = alasql('SELECT * FROM transformaciones WHERE indice=' + indice)[0],
                  columnas = FormularioJS.columnas[area];

               console.log('1853 - formulario datos datos ', datos);
               console.log('1854 - formulario datos area ', area);
               console.log('1855 - formulario datos columnas ', columnas);

               var tipo = columnas[3] ?
                  datos[columnas[3]] !== '' ?
                  'tmp_backlog' :
                  'tmp_aceptar' :
                  'tmp_backlog';
               console.log('1861 - formulario datos tipo ', tipo);
               const vigencia = datos['AR'] !== '' ?
                  alasql('SELECT ROW ' + tipo + ' FROM (SELECT * FROM area JOIN area_tmp USING id_area) WHERE nb_area = "' + area + '" AND tipologia="' + datos['AR'] + '"')[0] :
                  alasql('SELECT ROW ' + tipo + ' FROM (SELECT * FROM area JOIN area_tmp USING id_area) WHERE nb_area = "' + area + '"')[0];

               console.log('1875 vigencia', vigencia);
               var dias = '',
                  fchInicio = columnas[0] ?
                  datos[columnas[0]] !== '' ?
                  datos[columnas[0]] :
                  moment().format('YYYY-MM-DD') :
                  moment().format('YYYY-MM-DD'),
                  fchFinal = columnas[1] ?
                  datos[columnas[1]] !== '' ?
                  datos[columnas[1]] :
                  moment().format('YYYY-MM-DD') :
                  moment().format('YYYY-MM-DD');
               dias = MomentJS.obtenerDiferenciaFechas(fchFinal - fchInicio).diasLaborales + (moment().format('HH') >= "15" ? 1 : 0);
               //console.log('dias', fchInicio, fchFinal);
               //console.log('vigencia', vigencia, dias);
               var entiempo = Math.trunc(vigencia - dias);
               console.log('vigencia', vigencia);
               var texto = entiempo === 0 ?
                  'Por vencer' :
                  entiempo < 0 ?
                  'Fuera de tiempo' :
                  'En tiempo',
                  leyenda = (entiempo < 0 ? 'Se ha pasado por ' + (entiempo * -1) + ' día(s)' : 'Queda(n) ' + entiempo + ' día(s), Máximo: ' + vigencia + ' día(s)'),
                  clase = entiempo === 0 ?
                  'lbl-warning' :
                  entiempo < 0 ?
                  'lbl-error' :
                  'lbl-success';
               return [texto, leyenda, clase];
            },
            validacionPorMonto: function (montoUmbral, funcion, logDescription, valorError, datos) {
               console.log('validacionPorMonto', montoUmbral, funcion, logDescription, valorError, datos);
               var respuestaMonto;
               try {
                  var monto = alasql('SELECT D AS [monto] FROM transformaciones WHERE indice=' + FormularioJS.active)[0];
                  console.log('monto de validacionPorMonto', monto, funcion);
                  switch (funcion) {
                     case 'area':
                        respuestaMonto = Number(monto.monto) < montoUmbral ? '12' : '6';
                        break;
                     case 'siguiente':
                        respuestaMonto = Number(monto.monto) >= montoUmbral ? ['Auditoria'] : ['Aclaraciones-Auditoria'];
                        break;
                     case 'busqueda':
                        console.log('candado para momivientos mayores a 3M ', datos);
                        respuestaMonto = (alasql("SELECT * FROM ? WHERE area='Auditoria' AND (AR='Fraude Consumado > 3,000,000' OR  (AR='Fraude Consumado > 100,000')  and AC != '' AND P != ''  AND AA!='') OR ( AR='Fraude Consumado > 3,000,000') ", [datos]));
                        // respuestaMonto=  (alasql("SELECT * FROM ? WHERE area='Auditoria' AND (AR='Fraude Consumado > 100,000'  and AC != '' AND P != '' ' AND AA!='') OR ( AR='Fraude Consumado > 3,000,000') ",[datos]));
                        console.log('respuesta del monto', respuestaMonto);
                        break;
                     case 'aLaPar':
                        Number(monto.monto) >= montoUmbral ? datos.push('Auditoria') : datos;
                        respuestaMonto = datos;
                        console.log('respuestaMonto', datos);
                        break;
                     default:
                        throw new Error();
                        break;
                  }
               } catch (error) {
                  console.log('error controlado en monto');
                  respuestaMonto = valorError;
               }
               console.log('return respuestaMonto', respuestaMonto);
               return respuestaMonto;
            },
            sobreEscrituraSheet: function (){
         /* reglas para no sobreescribir datos :
          * si hay celdas con algun caracter y los datos a guardar vienen vacios de esa misma celda se quedan los datos con caratecr
          * cuando vienen celdas con caracteres y los datos a guardar vienen con caracteres , se planchas los datos */
            console.log('metodo sobreEscrituraSheet');
            var deferred =$.Deferred();
            var resultado;
            var valoresSesion=alasql('SELECT * FROM transformaciones WHERE indice ='+ FormularioJS.active)[0];
            $.when(HomeJS.obtenerDatosDeSpread('Base'))
              .then(function(resultado ) {
              //debugger;
                 var valoresExcel = alasql('SELECT * FROM transformaciones WHERE indice ='+ FormularioJS.active)[0];
                 console.log('valoresExcel  : ',valoresExcel);
                 console.log('valoresSesion  : ',valoresSesion);
                  // funcion para pasar los documentos de valores de sesion a valores de excel
                 if(sessionStorage.id_puesto=='2'){
                      var coordenadas=FormularioJS.documentosCoordenadas['AFG'];
                      coordenadas.forEach(function(coordenada,value){
                          valoresExcel[coordenada]=valoresSesion[coordenada];
                          FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                       })
                   }
                 else if(sessionStorage.id_puesto=='3'){
                      var coordenadas=FormularioJS.documentosCoordenadas['Seguridad'];
                      coordenadas.forEach(function(coordenada,value){
                       valoresExcel[coordenada]=valoresSesion[coordenada];
                       FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                       })
                   }
                 else if(sessionStorage.id_puesto=='6'||sessionStorage.id_puesto=='12'){
                       var coordenadas=FormularioJS.documentosCoordenadas['Auditoria'];
                       coordenadas.forEach(function(coordenada,value){
                       valoresExcel[coordenada]=valoresSesion[coordenada];
                       FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                       })
                   }
                 else if(sessionStorage.id_puesto=='6'||sessionStorage.id_puesto=='8'){
                      var coordenadas=FormularioJS.documentosCoordenadas['Aclaraciones'];
                      coordenadas.forEach(function(coordenada,value){
                       valoresExcel[coordenada]=valoresSesion[coordenada];
                       FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                       })
                   }
                 else if(sessionStorage.id_puesto=='9'){
                      var coordenadas=FormularioJS.documentosCoordenadas['RCI'];
                      coordenadas.forEach(function(coordenada,value){
                       valoresExcel[coordenada]=valoresSesion[coordenada];
                       FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                       })
                   }
                 else if(sessionStorage.id_puesto=='11'){
                      var coordenadas=FormularioJS.documentosCoordenadas['AFG2'];
                      coordenadas.forEach(function(coordenada,value){
                       valoresExcel[coordenada]=valoresSesion[coordenada];
                       FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                       })
                  }
                  else if(sessionStorage.id_puesto=='1'){
                       var coordenadas=FormularioJS.documentosCoordenadas;
                       for(x in coordenadas){
                            console.log(coordenadas[x]);
                            coordenadas[x].forEach(function(coordenada ,value){
                            valoresExcel[coordenada]=valoresSesion[coordenada];
                            FormularioJS.alasql.modificar(coordenada, valoresExcel[coordenada]);
                            })
                        }
                  }
                   deferred.resolve('ok');
               }).catch(function(error){
               console.log('error',error);
               })  ;
         return  deferred.promise();
       }
     }
   }
   
    </script>
